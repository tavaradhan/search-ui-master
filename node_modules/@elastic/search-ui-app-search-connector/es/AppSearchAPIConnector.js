import _asyncToGenerator from "@babel/runtime/helpers/asyncToGenerator";
import _classCallCheck from "@babel/runtime/helpers/classCallCheck";
import _createClass from "@babel/runtime/helpers/createClass";
import _defineProperty from "@babel/runtime/helpers/defineProperty";
import _objectWithoutProperties from "@babel/runtime/helpers/objectWithoutProperties";
var _excluded = ["facets", "filters"],
    _excluded2 = ["searchKey", "engineName", "hostIdentifier", "beforeSearchCall", "beforeAutocompleteResultsCall", "beforeAutocompleteSuggestionsCall", "endpointBase"],
    _excluded3 = ["current", "filters", "resultsPerPage", "sortDirection", "sortField", "sortList"],
    _excluded4 = ["query"],
    _excluded5 = ["current", "filters", "resultsPerPage", "sortDirection", "sortField", "sortList"],
    _excluded6 = ["query"];
import _regeneratorRuntime from "@babel/runtime/regenerator";

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

import * as ElasticAppSearch from "@elastic/app-search-javascript";
import { adaptResponse } from "./responseAdapter";
import { adaptRequest } from "./requestAdapters";
import buildResponseAdapterOptions from "./buildResponseAdapterOptions"; // The API will error out if empty facets or filters objects
// are sent.

function removeEmptyFacetsAndFilters(options) {
  var facets = options.facets,
      filters = options.filters,
      rest = _objectWithoutProperties(options, _excluded);

  return _objectSpread(_objectSpread(_objectSpread({}, facets && Object.entries(facets).length > 0 && {
    facets: facets
  }), filters && Object.entries(filters).length > 0 && {
    filters: filters
  }), rest);
}

var AppSearchAPIConnector = /*#__PURE__*/function () {
  /**
   * @callback next
   * @param {Object} updatedQueryOptions The options to send to the API
   */

  /**
   * @callback hook
   * @param {Object} queryOptions The options that are about to be sent to the API
   * @param {next} next The options that are about to be sent to the API
   */

  /**
   * @typedef Options
   * @param {string} searchKey Credential found in your App Search Dashboard
   * @param {string} engineName Engine to query, found in your App Search Dashboard
   * @param {string} hostIdentifier Credential found in your App Search Dashboard
   *  Useful when proxying the Swiftype API or developing against a local API server.
   * @param {hook} beforeSearchCall=(queryOptions,next)=>next(queryOptions) A hook to amend query options before the request is sent to the
   *   API in a query on an "onSearch" event.
   * @param {hook} beforeAutocompleteResultsCall=(queryOptions,next)=>next(queryOptions) A hook to amend query options before the request is sent to the
   *   API in a "results" query on an "onAutocomplete" event.
   * @param {hook} beforeAutocompleteSuggestionsCall=(queryOptions,next)=>next(queryOptions) A hook to amend query options before the request is sent to
   * the API in a "suggestions" query on an "onAutocomplete" event.
   * @param {string} endpointBase="" Overrides the base of the Swiftype API endpoint completely.
   */

  /**
   * @param {Options} options
   */
  function AppSearchAPIConnector(_ref) {
    var searchKey = _ref.searchKey,
        engineName = _ref.engineName,
        hostIdentifier = _ref.hostIdentifier,
        _ref$beforeSearchCall = _ref.beforeSearchCall,
        beforeSearchCall = _ref$beforeSearchCall === void 0 ? function (queryOptions, next) {
      return next(queryOptions);
    } : _ref$beforeSearchCall,
        _ref$beforeAutocomple = _ref.beforeAutocompleteResultsCall,
        beforeAutocompleteResultsCall = _ref$beforeAutocomple === void 0 ? function (queryOptions, next) {
      return next(queryOptions);
    } : _ref$beforeAutocomple,
        _ref$beforeAutocomple2 = _ref.beforeAutocompleteSuggestionsCall,
        beforeAutocompleteSuggestionsCall = _ref$beforeAutocomple2 === void 0 ? function (queryOptions, next) {
      return next(queryOptions);
    } : _ref$beforeAutocomple2,
        _ref$endpointBase = _ref.endpointBase,
        endpointBase = _ref$endpointBase === void 0 ? "" : _ref$endpointBase,
        rest = _objectWithoutProperties(_ref, _excluded2);

    _classCallCheck(this, AppSearchAPIConnector);

    if (!engineName || !(hostIdentifier || endpointBase)) {
      throw Error("hostIdentifier or endpointBase, and engineName are required");
    }

    this.client = ElasticAppSearch.createClient(_objectSpread(_objectSpread(_objectSpread({}, endpointBase && {
      endpointBase: endpointBase
    }), hostIdentifier && {
      hostIdentifier: hostIdentifier
    }), {}, {
      apiKey: searchKey,
      engineName: engineName
    }, rest));
    this.beforeSearchCall = beforeSearchCall;
    this.beforeAutocompleteResultsCall = beforeAutocompleteResultsCall;
    this.beforeAutocompleteSuggestionsCall = beforeAutocompleteSuggestionsCall;
  }

  _createClass(AppSearchAPIConnector, [{
    key: "onResultClick",
    value: function onResultClick(_ref2) {
      var query = _ref2.query,
          documentId = _ref2.documentId,
          requestId = _ref2.requestId,
          _ref2$tags = _ref2.tags,
          tags = _ref2$tags === void 0 ? [] : _ref2$tags;
      tags = tags.concat("results");
      return this.client.click({
        query: query,
        documentId: documentId,
        requestId: requestId,
        tags: tags
      });
    }
  }, {
    key: "onAutocompleteResultClick",
    value: function onAutocompleteResultClick(_ref3) {
      var query = _ref3.query,
          documentId = _ref3.documentId,
          requestId = _ref3.requestId,
          _ref3$tags = _ref3.tags,
          tags = _ref3$tags === void 0 ? [] : _ref3$tags;
      tags = tags.concat("autocomplete");
      return this.client.click({
        query: query,
        documentId: documentId,
        requestId: requestId,
        tags: tags
      });
    }
  }, {
    key: "onSearch",
    value: function () {
      var _onSearch = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(state, queryConfig) {
        var _this = this;

        var current, filters, resultsPerPage, sortDirection, sortField, sortList, restOfQueryConfig, _adaptRequest, query, optionsFromState, withQueryConfigOptions, options;

        return _regeneratorRuntime.wrap(function _callee2$(_context2) {
          while (1) {
            switch (_context2.prev = _context2.next) {
              case 0:
                current = queryConfig.current, filters = queryConfig.filters, resultsPerPage = queryConfig.resultsPerPage, sortDirection = queryConfig.sortDirection, sortField = queryConfig.sortField, sortList = queryConfig.sortList, restOfQueryConfig = _objectWithoutProperties(queryConfig, _excluded3);
                _adaptRequest = adaptRequest(_objectSpread(_objectSpread(_objectSpread(_objectSpread(_objectSpread(_objectSpread(_objectSpread({}, state), current !== undefined && {
                  current: current
                }), filters !== undefined && {
                  filters: filters
                }), resultsPerPage !== undefined && {
                  resultsPerPage: resultsPerPage
                }), sortDirection !== undefined && {
                  sortDirection: sortDirection
                }), sortField !== undefined && {
                  sortField: sortField
                }), sortList !== undefined && {
                  sortList: sortList
                })), query = _adaptRequest.query, optionsFromState = _objectWithoutProperties(_adaptRequest, _excluded4);
                withQueryConfigOptions = _objectSpread(_objectSpread({}, restOfQueryConfig), optionsFromState);
                options = _objectSpread({}, removeEmptyFacetsAndFilters(withQueryConfigOptions));
                return _context2.abrupt("return", this.beforeSearchCall(options, /*#__PURE__*/function () {
                  var _ref4 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(newOptions) {
                    var response;
                    return _regeneratorRuntime.wrap(function _callee$(_context) {
                      while (1) {
                        switch (_context.prev = _context.next) {
                          case 0:
                            _context.next = 2;
                            return _this.client.search(query, newOptions);

                          case 2:
                            response = _context.sent;
                            return _context.abrupt("return", adaptResponse(response, buildResponseAdapterOptions(queryConfig)));

                          case 4:
                          case "end":
                            return _context.stop();
                        }
                      }
                    }, _callee);
                  }));

                  return function (_x3) {
                    return _ref4.apply(this, arguments);
                  };
                }()));

              case 5:
              case "end":
                return _context2.stop();
            }
          }
        }, _callee2, this);
      }));

      function onSearch(_x, _x2) {
        return _onSearch.apply(this, arguments);
      }

      return onSearch;
    }()
  }, {
    key: "onAutocomplete",
    value: function () {
      var _onAutocomplete = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3(_ref5, queryConfig) {
        var _this2 = this;

        var searchTerm, autocompletedState, promises, _queryConfig$results, current, filters, resultsPerPage, sortDirection, sortField, sortList, restOfQueryConfig, _adaptRequest2, query, optionsFromState, withQueryConfigOptions, options, _options;

        return _regeneratorRuntime.wrap(function _callee3$(_context3) {
          while (1) {
            switch (_context3.prev = _context3.next) {
              case 0:
                searchTerm = _ref5.searchTerm;
                autocompletedState = {};
                promises = [];

                if (queryConfig.results) {
                  _queryConfig$results = queryConfig.results, current = _queryConfig$results.current, filters = _queryConfig$results.filters, resultsPerPage = _queryConfig$results.resultsPerPage, sortDirection = _queryConfig$results.sortDirection, sortField = _queryConfig$results.sortField, sortList = _queryConfig$results.sortList, restOfQueryConfig = _objectWithoutProperties(_queryConfig$results, _excluded5);
                  _adaptRequest2 = adaptRequest({
                    current: current,
                    searchTerm: searchTerm,
                    filters: filters,
                    resultsPerPage: resultsPerPage,
                    sortDirection: sortDirection,
                    sortField: sortField,
                    sortList: sortList
                  }), query = _adaptRequest2.query, optionsFromState = _objectWithoutProperties(_adaptRequest2, _excluded6);
                  withQueryConfigOptions = _objectSpread(_objectSpread({}, restOfQueryConfig), optionsFromState);
                  options = removeEmptyFacetsAndFilters(withQueryConfigOptions);
                  promises.push(this.beforeAutocompleteResultsCall(options, function (newOptions) {
                    return _this2.client.search(query, newOptions).then(function (response) {
                      autocompletedState.autocompletedResults = adaptResponse(response).results;
                      autocompletedState.autocompletedResultsRequestId = response.info.meta.request_id;
                    });
                  }));
                }

                if (queryConfig.suggestions) {
                  _options = queryConfig.suggestions;
                  promises.push(this.beforeAutocompleteSuggestionsCall(_options, function (newOptions) {
                    return _this2.client.querySuggestion(searchTerm, newOptions).then(function (response) {
                      autocompletedState.autocompletedSuggestions = response.results;
                      autocompletedState.autocompletedSuggestionsRequestId = response.meta.request_id;
                    });
                  }));
                }

                _context3.next = 7;
                return Promise.all(promises);

              case 7:
                return _context3.abrupt("return", autocompletedState);

              case 8:
              case "end":
                return _context3.stop();
            }
          }
        }, _callee3, this);
      }));

      function onAutocomplete(_x4, _x5) {
        return _onAutocomplete.apply(this, arguments);
      }

      return onAutocomplete;
    }()
  }]);

  return AppSearchAPIConnector;
}();

export default AppSearchAPIConnector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9BcHBTZWFyY2hBUElDb25uZWN0b3IuanMiXSwibmFtZXMiOlsiRWxhc3RpY0FwcFNlYXJjaCIsImFkYXB0UmVzcG9uc2UiLCJhZGFwdFJlcXVlc3QiLCJidWlsZFJlc3BvbnNlQWRhcHRlck9wdGlvbnMiLCJyZW1vdmVFbXB0eUZhY2V0c0FuZEZpbHRlcnMiLCJvcHRpb25zIiwiZmFjZXRzIiwiZmlsdGVycyIsInJlc3QiLCJPYmplY3QiLCJlbnRyaWVzIiwibGVuZ3RoIiwiQXBwU2VhcmNoQVBJQ29ubmVjdG9yIiwic2VhcmNoS2V5IiwiZW5naW5lTmFtZSIsImhvc3RJZGVudGlmaWVyIiwiYmVmb3JlU2VhcmNoQ2FsbCIsInF1ZXJ5T3B0aW9ucyIsIm5leHQiLCJiZWZvcmVBdXRvY29tcGxldGVSZXN1bHRzQ2FsbCIsImJlZm9yZUF1dG9jb21wbGV0ZVN1Z2dlc3Rpb25zQ2FsbCIsImVuZHBvaW50QmFzZSIsIkVycm9yIiwiY2xpZW50IiwiY3JlYXRlQ2xpZW50IiwiYXBpS2V5IiwicXVlcnkiLCJkb2N1bWVudElkIiwicmVxdWVzdElkIiwidGFncyIsImNvbmNhdCIsImNsaWNrIiwic3RhdGUiLCJxdWVyeUNvbmZpZyIsImN1cnJlbnQiLCJyZXN1bHRzUGVyUGFnZSIsInNvcnREaXJlY3Rpb24iLCJzb3J0RmllbGQiLCJzb3J0TGlzdCIsInJlc3RPZlF1ZXJ5Q29uZmlnIiwidW5kZWZpbmVkIiwib3B0aW9uc0Zyb21TdGF0ZSIsIndpdGhRdWVyeUNvbmZpZ09wdGlvbnMiLCJuZXdPcHRpb25zIiwic2VhcmNoIiwicmVzcG9uc2UiLCJzZWFyY2hUZXJtIiwiYXV0b2NvbXBsZXRlZFN0YXRlIiwicHJvbWlzZXMiLCJyZXN1bHRzIiwicHVzaCIsInRoZW4iLCJhdXRvY29tcGxldGVkUmVzdWx0cyIsImF1dG9jb21wbGV0ZWRSZXN1bHRzUmVxdWVzdElkIiwiaW5mbyIsIm1ldGEiLCJyZXF1ZXN0X2lkIiwic3VnZ2VzdGlvbnMiLCJxdWVyeVN1Z2dlc3Rpb24iLCJhdXRvY29tcGxldGVkU3VnZ2VzdGlvbnMiLCJhdXRvY29tcGxldGVkU3VnZ2VzdGlvbnNSZXF1ZXN0SWQiLCJQcm9taXNlIiwiYWxsIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLE9BQU8sS0FBS0EsZ0JBQVosTUFBa0MsZ0NBQWxDO0FBRUEsU0FBU0MsYUFBVCxRQUE4QixtQkFBOUI7QUFDQSxTQUFTQyxZQUFULFFBQTZCLG1CQUE3QjtBQUNBLE9BQU9DLDJCQUFQLE1BQXdDLCtCQUF4QyxDLENBRUE7QUFDQTs7QUFDQSxTQUFTQywyQkFBVCxDQUFxQ0MsT0FBckMsRUFBOEM7QUFDNUMsTUFBUUMsTUFBUixHQUFxQ0QsT0FBckMsQ0FBUUMsTUFBUjtBQUFBLE1BQWdCQyxPQUFoQixHQUFxQ0YsT0FBckMsQ0FBZ0JFLE9BQWhCO0FBQUEsTUFBNEJDLElBQTVCLDRCQUFxQ0gsT0FBckM7O0FBQ0EsdURBQ01DLE1BQU0sSUFBSUcsTUFBTSxDQUFDQyxPQUFQLENBQWVKLE1BQWYsRUFBdUJLLE1BQXZCLEdBQWdDLENBQTFDLElBQStDO0FBQUVMLElBQUFBLE1BQU0sRUFBTkE7QUFBRixHQURyRCxHQUVNQyxPQUFPLElBQUlFLE1BQU0sQ0FBQ0MsT0FBUCxDQUFlSCxPQUFmLEVBQXdCSSxNQUF4QixHQUFpQyxDQUE1QyxJQUFpRDtBQUFFSixJQUFBQSxPQUFPLEVBQVBBO0FBQUYsR0FGdkQsR0FHS0MsSUFITDtBQUtEOztJQUNLSSxxQjtBQUNKO0FBQ0Y7QUFDQTtBQUNBOztBQUVFO0FBQ0Y7QUFDQTtBQUNBO0FBQ0E7O0FBRUU7QUFDRjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFRTtBQUNGO0FBQ0E7QUFDRSx1Q0FVRztBQUFBLFFBVERDLFNBU0MsUUFUREEsU0FTQztBQUFBLFFBUkRDLFVBUUMsUUFSREEsVUFRQztBQUFBLFFBUERDLGNBT0MsUUFQREEsY0FPQztBQUFBLHFDQU5EQyxnQkFNQztBQUFBLFFBTkRBLGdCQU1DLHNDQU5rQixVQUFDQyxZQUFELEVBQWVDLElBQWY7QUFBQSxhQUF3QkEsSUFBSSxDQUFDRCxZQUFELENBQTVCO0FBQUEsS0FNbEI7QUFBQSxxQ0FMREUsNkJBS0M7QUFBQSxRQUxEQSw2QkFLQyxzQ0FMK0IsVUFBQ0YsWUFBRCxFQUFlQyxJQUFmO0FBQUEsYUFBd0JBLElBQUksQ0FBQ0QsWUFBRCxDQUE1QjtBQUFBLEtBSy9CO0FBQUEsc0NBSkRHLGlDQUlDO0FBQUEsUUFKREEsaUNBSUMsdUNBSm1DLFVBQUNILFlBQUQsRUFBZUMsSUFBZjtBQUFBLGFBQ2xDQSxJQUFJLENBQUNELFlBQUQsQ0FEOEI7QUFBQSxLQUluQztBQUFBLGlDQUZESSxZQUVDO0FBQUEsUUFGREEsWUFFQyxrQ0FGYyxFQUVkO0FBQUEsUUFERWIsSUFDRjs7QUFBQTs7QUFDRCxRQUFJLENBQUNNLFVBQUQsSUFBZSxFQUFFQyxjQUFjLElBQUlNLFlBQXBCLENBQW5CLEVBQXNEO0FBQ3BELFlBQU1DLEtBQUssQ0FDVCw2REFEUyxDQUFYO0FBR0Q7O0FBRUQsU0FBS0MsTUFBTCxHQUFjdkIsZ0JBQWdCLENBQUN3QixZQUFqQiwrQ0FDUkgsWUFBWSxJQUFJO0FBQUVBLE1BQUFBLFlBQVksRUFBWkE7QUFBRixLQURSLEdBRVJOLGNBQWMsSUFBSTtBQUFFQSxNQUFBQSxjQUFjLEVBQUVBO0FBQWxCLEtBRlY7QUFHWlUsTUFBQUEsTUFBTSxFQUFFWixTQUhJO0FBSVpDLE1BQUFBLFVBQVUsRUFBRUE7QUFKQSxPQUtUTixJQUxTLEVBQWQ7QUFPQSxTQUFLUSxnQkFBTCxHQUF3QkEsZ0JBQXhCO0FBQ0EsU0FBS0csNkJBQUwsR0FBcUNBLDZCQUFyQztBQUNBLFNBQUtDLGlDQUFMLEdBQXlDQSxpQ0FBekM7QUFDRDs7OztXQUVELDhCQUEyRDtBQUFBLFVBQTNDTSxLQUEyQyxTQUEzQ0EsS0FBMkM7QUFBQSxVQUFwQ0MsVUFBb0MsU0FBcENBLFVBQW9DO0FBQUEsVUFBeEJDLFNBQXdCLFNBQXhCQSxTQUF3QjtBQUFBLDZCQUFiQyxJQUFhO0FBQUEsVUFBYkEsSUFBYSwyQkFBTixFQUFNO0FBQ3pEQSxNQUFBQSxJQUFJLEdBQUdBLElBQUksQ0FBQ0MsTUFBTCxDQUFZLFNBQVosQ0FBUDtBQUNBLGFBQU8sS0FBS1AsTUFBTCxDQUFZUSxLQUFaLENBQWtCO0FBQUVMLFFBQUFBLEtBQUssRUFBTEEsS0FBRjtBQUFTQyxRQUFBQSxVQUFVLEVBQVZBLFVBQVQ7QUFBcUJDLFFBQUFBLFNBQVMsRUFBVEEsU0FBckI7QUFBZ0NDLFFBQUFBLElBQUksRUFBSkE7QUFBaEMsT0FBbEIsQ0FBUDtBQUNEOzs7V0FFRCwwQ0FBdUU7QUFBQSxVQUEzQ0gsS0FBMkMsU0FBM0NBLEtBQTJDO0FBQUEsVUFBcENDLFVBQW9DLFNBQXBDQSxVQUFvQztBQUFBLFVBQXhCQyxTQUF3QixTQUF4QkEsU0FBd0I7QUFBQSw2QkFBYkMsSUFBYTtBQUFBLFVBQWJBLElBQWEsMkJBQU4sRUFBTTtBQUNyRUEsTUFBQUEsSUFBSSxHQUFHQSxJQUFJLENBQUNDLE1BQUwsQ0FBWSxjQUFaLENBQVA7QUFDQSxhQUFPLEtBQUtQLE1BQUwsQ0FBWVEsS0FBWixDQUFrQjtBQUFFTCxRQUFBQSxLQUFLLEVBQUxBLEtBQUY7QUFBU0MsUUFBQUEsVUFBVSxFQUFWQSxVQUFUO0FBQXFCQyxRQUFBQSxTQUFTLEVBQVRBLFNBQXJCO0FBQWdDQyxRQUFBQSxJQUFJLEVBQUpBO0FBQWhDLE9BQWxCLENBQVA7QUFDRDs7OzsrRUFFRCxrQkFBZUcsS0FBZixFQUFzQkMsV0FBdEI7QUFBQTs7QUFBQTs7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUVJQyxnQkFBQUEsT0FGSixHQVNNRCxXQVROLENBRUlDLE9BRkosRUFHSTNCLE9BSEosR0FTTTBCLFdBVE4sQ0FHSTFCLE9BSEosRUFJSTRCLGNBSkosR0FTTUYsV0FUTixDQUlJRSxjQUpKLEVBS0lDLGFBTEosR0FTTUgsV0FUTixDQUtJRyxhQUxKLEVBTUlDLFNBTkosR0FTTUosV0FUTixDQU1JSSxTQU5KLEVBT0lDLFFBUEosR0FTTUwsV0FUTixDQU9JSyxRQVBKLEVBUU9DLGlCQVJQLDRCQVNNTixXQVROO0FBQUEsZ0NBV3lDL0IsWUFBWSx1R0FDOUM4QixLQUQ4QyxHQUU3Q0UsT0FBTyxLQUFLTSxTQUFaLElBQXlCO0FBQUVOLGtCQUFBQSxPQUFPLEVBQVBBO0FBQUYsaUJBRm9CLEdBRzdDM0IsT0FBTyxLQUFLaUMsU0FBWixJQUF5QjtBQUFFakMsa0JBQUFBLE9BQU8sRUFBUEE7QUFBRixpQkFIb0IsR0FJN0M0QixjQUFjLEtBQUtLLFNBQW5CLElBQWdDO0FBQUVMLGtCQUFBQSxjQUFjLEVBQWRBO0FBQUYsaUJBSmEsR0FLN0NDLGFBQWEsS0FBS0ksU0FBbEIsSUFBK0I7QUFBRUosa0JBQUFBLGFBQWEsRUFBYkE7QUFBRixpQkFMYyxHQU03Q0MsU0FBUyxLQUFLRyxTQUFkLElBQTJCO0FBQUVILGtCQUFBQSxTQUFTLEVBQVRBO0FBQUYsaUJBTmtCLEdBTzdDQyxRQUFRLEtBQUtFLFNBQWIsSUFBMEI7QUFBRUYsa0JBQUFBLFFBQVEsRUFBUkE7QUFBRixpQkFQbUIsRUFYckQsRUFXVVosS0FYVixpQkFXVUEsS0FYVixFQVdvQmUsZ0JBWHBCO0FBcUJRQyxnQkFBQUEsc0JBckJSLG1DQXNCT0gsaUJBdEJQLEdBdUJPRSxnQkF2QlA7QUF5QlFwQyxnQkFBQUEsT0F6QlIscUJBMEJPRCwyQkFBMkIsQ0FBQ3NDLHNCQUFELENBMUJsQztBQUFBLGtEQTZCUyxLQUFLMUIsZ0JBQUwsQ0FBc0JYLE9BQXRCO0FBQUEsdUZBQStCLGlCQUFNc0MsVUFBTjtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBLG1DQUNiLEtBQUksQ0FBQ3BCLE1BQUwsQ0FBWXFCLE1BQVosQ0FBbUJsQixLQUFuQixFQUEwQmlCLFVBQTFCLENBRGE7O0FBQUE7QUFDOUJFLDRCQUFBQSxRQUQ4QjtBQUFBLDZEQUU3QjVDLGFBQWEsQ0FBQzRDLFFBQUQsRUFBVzFDLDJCQUEyQixDQUFDOEIsV0FBRCxDQUF0QyxDQUZnQjs7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQSxtQkFBL0I7O0FBQUE7QUFBQTtBQUFBO0FBQUEsb0JBN0JUOztBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBLE87Ozs7Ozs7Ozs7O3FGQW1DQSx5QkFBcUNBLFdBQXJDO0FBQUE7O0FBQUE7O0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBdUJhLGdCQUFBQSxVQUF2QixTQUF1QkEsVUFBdkI7QUFDUUMsZ0JBQUFBLGtCQURSLEdBQzZCLEVBRDdCO0FBRU1DLGdCQUFBQSxRQUZOLEdBRWlCLEVBRmpCOztBQUlFLG9CQUFJZixXQUFXLENBQUNnQixPQUFoQixFQUF5QjtBQUFBLHlDQVNuQmhCLFdBQVcsQ0FBQ2dCLE9BVE8sRUFFckJmLE9BRnFCLHdCQUVyQkEsT0FGcUIsRUFHckIzQixPQUhxQix3QkFHckJBLE9BSHFCLEVBSXJCNEIsY0FKcUIsd0JBSXJCQSxjQUpxQixFQUtyQkMsYUFMcUIsd0JBS3JCQSxhQUxxQixFQU1yQkMsU0FOcUIsd0JBTXJCQSxTQU5xQixFQU9yQkMsUUFQcUIsd0JBT3JCQSxRQVBxQixFQVFsQkMsaUJBUmtCO0FBQUEsbUNBV2dCckMsWUFBWSxDQUFDO0FBQ2xEZ0Msb0JBQUFBLE9BQU8sRUFBUEEsT0FEa0Q7QUFFbERZLG9CQUFBQSxVQUFVLEVBQVZBLFVBRmtEO0FBR2xEdkMsb0JBQUFBLE9BQU8sRUFBUEEsT0FIa0Q7QUFJbEQ0QixvQkFBQUEsY0FBYyxFQUFkQSxjQUprRDtBQUtsREMsb0JBQUFBLGFBQWEsRUFBYkEsYUFMa0Q7QUFNbERDLG9CQUFBQSxTQUFTLEVBQVRBLFNBTmtEO0FBT2xEQyxvQkFBQUEsUUFBUSxFQUFSQTtBQVBrRCxtQkFBRCxDQVg1QixFQVdmWixLQVhlLGtCQVdmQSxLQVhlLEVBV0xlLGdCQVhLO0FBcUJqQkMsa0JBQUFBLHNCQXJCaUIsbUNBc0JsQkgsaUJBdEJrQixHQXVCbEJFLGdCQXZCa0I7QUF5QmpCcEMsa0JBQUFBLE9BekJpQixHQXlCUEQsMkJBQTJCLENBQUNzQyxzQkFBRCxDQXpCcEI7QUEwQnZCTSxrQkFBQUEsUUFBUSxDQUFDRSxJQUFULENBQ0UsS0FBSy9CLDZCQUFMLENBQW1DZCxPQUFuQyxFQUE0QyxVQUFBc0MsVUFBVSxFQUFJO0FBQ3hELDJCQUFPLE1BQUksQ0FBQ3BCLE1BQUwsQ0FBWXFCLE1BQVosQ0FBbUJsQixLQUFuQixFQUEwQmlCLFVBQTFCLEVBQXNDUSxJQUF0QyxDQUEyQyxVQUFBTixRQUFRLEVBQUk7QUFDNURFLHNCQUFBQSxrQkFBa0IsQ0FBQ0ssb0JBQW5CLEdBQTBDbkQsYUFBYSxDQUNyRDRDLFFBRHFELENBQWIsQ0FFeENJLE9BRkY7QUFHQUYsc0JBQUFBLGtCQUFrQixDQUFDTSw2QkFBbkIsR0FDRVIsUUFBUSxDQUFDUyxJQUFULENBQWNDLElBQWQsQ0FBbUJDLFVBRHJCO0FBRUQscUJBTk0sQ0FBUDtBQU9ELG1CQVJELENBREY7QUFXRDs7QUFFRCxvQkFBSXZCLFdBQVcsQ0FBQ3dCLFdBQWhCLEVBQTZCO0FBQ3JCcEQsa0JBQUFBLFFBRHFCLEdBQ1g0QixXQUFXLENBQUN3QixXQUREO0FBRzNCVCxrQkFBQUEsUUFBUSxDQUFDRSxJQUFULENBQ0UsS0FBSzlCLGlDQUFMLENBQXVDZixRQUF2QyxFQUFnRCxVQUFBc0MsVUFBVTtBQUFBLDJCQUN4RCxNQUFJLENBQUNwQixNQUFMLENBQVltQyxlQUFaLENBQTRCWixVQUE1QixFQUF3Q0gsVUFBeEMsRUFBb0RRLElBQXBELENBQXlELFVBQUFOLFFBQVEsRUFBSTtBQUNuRUUsc0JBQUFBLGtCQUFrQixDQUFDWSx3QkFBbkIsR0FBOENkLFFBQVEsQ0FBQ0ksT0FBdkQ7QUFDQUYsc0JBQUFBLGtCQUFrQixDQUFDYSxpQ0FBbkIsR0FDRWYsUUFBUSxDQUFDVSxJQUFULENBQWNDLFVBRGhCO0FBRUQscUJBSkQsQ0FEd0Q7QUFBQSxtQkFBMUQsQ0FERjtBQVNEOztBQXZESDtBQUFBLHVCQXlEUUssT0FBTyxDQUFDQyxHQUFSLENBQVlkLFFBQVosQ0F6RFI7O0FBQUE7QUFBQSxrREEwRFNELGtCQTFEVDs7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQSxPOzs7Ozs7Ozs7Ozs7O0FBOERGLGVBQWVuQyxxQkFBZiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIEVsYXN0aWNBcHBTZWFyY2ggZnJvbSBcIkBlbGFzdGljL2FwcC1zZWFyY2gtamF2YXNjcmlwdFwiO1xuXG5pbXBvcnQgeyBhZGFwdFJlc3BvbnNlIH0gZnJvbSBcIi4vcmVzcG9uc2VBZGFwdGVyXCI7XG5pbXBvcnQgeyBhZGFwdFJlcXVlc3QgfSBmcm9tIFwiLi9yZXF1ZXN0QWRhcHRlcnNcIjtcbmltcG9ydCBidWlsZFJlc3BvbnNlQWRhcHRlck9wdGlvbnMgZnJvbSBcIi4vYnVpbGRSZXNwb25zZUFkYXB0ZXJPcHRpb25zXCI7XG5cbi8vIFRoZSBBUEkgd2lsbCBlcnJvciBvdXQgaWYgZW1wdHkgZmFjZXRzIG9yIGZpbHRlcnMgb2JqZWN0c1xuLy8gYXJlIHNlbnQuXG5mdW5jdGlvbiByZW1vdmVFbXB0eUZhY2V0c0FuZEZpbHRlcnMob3B0aW9ucykge1xuICBjb25zdCB7IGZhY2V0cywgZmlsdGVycywgLi4ucmVzdCB9ID0gb3B0aW9ucztcbiAgcmV0dXJuIHtcbiAgICAuLi4oZmFjZXRzICYmIE9iamVjdC5lbnRyaWVzKGZhY2V0cykubGVuZ3RoID4gMCAmJiB7IGZhY2V0cyB9KSxcbiAgICAuLi4oZmlsdGVycyAmJiBPYmplY3QuZW50cmllcyhmaWx0ZXJzKS5sZW5ndGggPiAwICYmIHsgZmlsdGVycyB9KSxcbiAgICAuLi5yZXN0XG4gIH07XG59XG5jbGFzcyBBcHBTZWFyY2hBUElDb25uZWN0b3Ige1xuICAvKipcbiAgICogQGNhbGxiYWNrIG5leHRcbiAgICogQHBhcmFtIHtPYmplY3R9IHVwZGF0ZWRRdWVyeU9wdGlvbnMgVGhlIG9wdGlvbnMgdG8gc2VuZCB0byB0aGUgQVBJXG4gICAqL1xuXG4gIC8qKlxuICAgKiBAY2FsbGJhY2sgaG9va1xuICAgKiBAcGFyYW0ge09iamVjdH0gcXVlcnlPcHRpb25zIFRoZSBvcHRpb25zIHRoYXQgYXJlIGFib3V0IHRvIGJlIHNlbnQgdG8gdGhlIEFQSVxuICAgKiBAcGFyYW0ge25leHR9IG5leHQgVGhlIG9wdGlvbnMgdGhhdCBhcmUgYWJvdXQgdG8gYmUgc2VudCB0byB0aGUgQVBJXG4gICAqL1xuXG4gIC8qKlxuICAgKiBAdHlwZWRlZiBPcHRpb25zXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBzZWFyY2hLZXkgQ3JlZGVudGlhbCBmb3VuZCBpbiB5b3VyIEFwcCBTZWFyY2ggRGFzaGJvYXJkXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBlbmdpbmVOYW1lIEVuZ2luZSB0byBxdWVyeSwgZm91bmQgaW4geW91ciBBcHAgU2VhcmNoIERhc2hib2FyZFxuICAgKiBAcGFyYW0ge3N0cmluZ30gaG9zdElkZW50aWZpZXIgQ3JlZGVudGlhbCBmb3VuZCBpbiB5b3VyIEFwcCBTZWFyY2ggRGFzaGJvYXJkXG4gICAqICBVc2VmdWwgd2hlbiBwcm94eWluZyB0aGUgU3dpZnR5cGUgQVBJIG9yIGRldmVsb3BpbmcgYWdhaW5zdCBhIGxvY2FsIEFQSSBzZXJ2ZXIuXG4gICAqIEBwYXJhbSB7aG9va30gYmVmb3JlU2VhcmNoQ2FsbD0ocXVlcnlPcHRpb25zLG5leHQpPT5uZXh0KHF1ZXJ5T3B0aW9ucykgQSBob29rIHRvIGFtZW5kIHF1ZXJ5IG9wdGlvbnMgYmVmb3JlIHRoZSByZXF1ZXN0IGlzIHNlbnQgdG8gdGhlXG4gICAqICAgQVBJIGluIGEgcXVlcnkgb24gYW4gXCJvblNlYXJjaFwiIGV2ZW50LlxuICAgKiBAcGFyYW0ge2hvb2t9IGJlZm9yZUF1dG9jb21wbGV0ZVJlc3VsdHNDYWxsPShxdWVyeU9wdGlvbnMsbmV4dCk9Pm5leHQocXVlcnlPcHRpb25zKSBBIGhvb2sgdG8gYW1lbmQgcXVlcnkgb3B0aW9ucyBiZWZvcmUgdGhlIHJlcXVlc3QgaXMgc2VudCB0byB0aGVcbiAgICogICBBUEkgaW4gYSBcInJlc3VsdHNcIiBxdWVyeSBvbiBhbiBcIm9uQXV0b2NvbXBsZXRlXCIgZXZlbnQuXG4gICAqIEBwYXJhbSB7aG9va30gYmVmb3JlQXV0b2NvbXBsZXRlU3VnZ2VzdGlvbnNDYWxsPShxdWVyeU9wdGlvbnMsbmV4dCk9Pm5leHQocXVlcnlPcHRpb25zKSBBIGhvb2sgdG8gYW1lbmQgcXVlcnkgb3B0aW9ucyBiZWZvcmUgdGhlIHJlcXVlc3QgaXMgc2VudCB0b1xuICAgKiB0aGUgQVBJIGluIGEgXCJzdWdnZXN0aW9uc1wiIHF1ZXJ5IG9uIGFuIFwib25BdXRvY29tcGxldGVcIiBldmVudC5cbiAgICogQHBhcmFtIHtzdHJpbmd9IGVuZHBvaW50QmFzZT1cIlwiIE92ZXJyaWRlcyB0aGUgYmFzZSBvZiB0aGUgU3dpZnR5cGUgQVBJIGVuZHBvaW50IGNvbXBsZXRlbHkuXG4gICAqL1xuXG4gIC8qKlxuICAgKiBAcGFyYW0ge09wdGlvbnN9IG9wdGlvbnNcbiAgICovXG4gIGNvbnN0cnVjdG9yKHtcbiAgICBzZWFyY2hLZXksXG4gICAgZW5naW5lTmFtZSxcbiAgICBob3N0SWRlbnRpZmllcixcbiAgICBiZWZvcmVTZWFyY2hDYWxsID0gKHF1ZXJ5T3B0aW9ucywgbmV4dCkgPT4gbmV4dChxdWVyeU9wdGlvbnMpLFxuICAgIGJlZm9yZUF1dG9jb21wbGV0ZVJlc3VsdHNDYWxsID0gKHF1ZXJ5T3B0aW9ucywgbmV4dCkgPT4gbmV4dChxdWVyeU9wdGlvbnMpLFxuICAgIGJlZm9yZUF1dG9jb21wbGV0ZVN1Z2dlc3Rpb25zQ2FsbCA9IChxdWVyeU9wdGlvbnMsIG5leHQpID0+XG4gICAgICBuZXh0KHF1ZXJ5T3B0aW9ucyksXG4gICAgZW5kcG9pbnRCYXNlID0gXCJcIixcbiAgICAuLi5yZXN0XG4gIH0pIHtcbiAgICBpZiAoIWVuZ2luZU5hbWUgfHwgIShob3N0SWRlbnRpZmllciB8fCBlbmRwb2ludEJhc2UpKSB7XG4gICAgICB0aHJvdyBFcnJvcihcbiAgICAgICAgXCJob3N0SWRlbnRpZmllciBvciBlbmRwb2ludEJhc2UsIGFuZCBlbmdpbmVOYW1lIGFyZSByZXF1aXJlZFwiXG4gICAgICApO1xuICAgIH1cblxuICAgIHRoaXMuY2xpZW50ID0gRWxhc3RpY0FwcFNlYXJjaC5jcmVhdGVDbGllbnQoe1xuICAgICAgLi4uKGVuZHBvaW50QmFzZSAmJiB7IGVuZHBvaW50QmFzZSB9KSwgLy9BZGQgcHJvcGVydHkgb24gY29uZGl0aW9uXG4gICAgICAuLi4oaG9zdElkZW50aWZpZXIgJiYgeyBob3N0SWRlbnRpZmllcjogaG9zdElkZW50aWZpZXIgfSksXG4gICAgICBhcGlLZXk6IHNlYXJjaEtleSxcbiAgICAgIGVuZ2luZU5hbWU6IGVuZ2luZU5hbWUsXG4gICAgICAuLi5yZXN0XG4gICAgfSk7XG4gICAgdGhpcy5iZWZvcmVTZWFyY2hDYWxsID0gYmVmb3JlU2VhcmNoQ2FsbDtcbiAgICB0aGlzLmJlZm9yZUF1dG9jb21wbGV0ZVJlc3VsdHNDYWxsID0gYmVmb3JlQXV0b2NvbXBsZXRlUmVzdWx0c0NhbGw7XG4gICAgdGhpcy5iZWZvcmVBdXRvY29tcGxldGVTdWdnZXN0aW9uc0NhbGwgPSBiZWZvcmVBdXRvY29tcGxldGVTdWdnZXN0aW9uc0NhbGw7XG4gIH1cblxuICBvblJlc3VsdENsaWNrKHsgcXVlcnksIGRvY3VtZW50SWQsIHJlcXVlc3RJZCwgdGFncyA9IFtdIH0pIHtcbiAgICB0YWdzID0gdGFncy5jb25jYXQoXCJyZXN1bHRzXCIpO1xuICAgIHJldHVybiB0aGlzLmNsaWVudC5jbGljayh7IHF1ZXJ5LCBkb2N1bWVudElkLCByZXF1ZXN0SWQsIHRhZ3MgfSk7XG4gIH1cblxuICBvbkF1dG9jb21wbGV0ZVJlc3VsdENsaWNrKHsgcXVlcnksIGRvY3VtZW50SWQsIHJlcXVlc3RJZCwgdGFncyA9IFtdIH0pIHtcbiAgICB0YWdzID0gdGFncy5jb25jYXQoXCJhdXRvY29tcGxldGVcIik7XG4gICAgcmV0dXJuIHRoaXMuY2xpZW50LmNsaWNrKHsgcXVlcnksIGRvY3VtZW50SWQsIHJlcXVlc3RJZCwgdGFncyB9KTtcbiAgfVxuXG4gIGFzeW5jIG9uU2VhcmNoKHN0YXRlLCBxdWVyeUNvbmZpZykge1xuICAgIGNvbnN0IHtcbiAgICAgIGN1cnJlbnQsXG4gICAgICBmaWx0ZXJzLFxuICAgICAgcmVzdWx0c1BlclBhZ2UsXG4gICAgICBzb3J0RGlyZWN0aW9uLFxuICAgICAgc29ydEZpZWxkLFxuICAgICAgc29ydExpc3QsXG4gICAgICAuLi5yZXN0T2ZRdWVyeUNvbmZpZ1xuICAgIH0gPSBxdWVyeUNvbmZpZztcblxuICAgIGNvbnN0IHsgcXVlcnksIC4uLm9wdGlvbnNGcm9tU3RhdGUgfSA9IGFkYXB0UmVxdWVzdCh7XG4gICAgICAuLi5zdGF0ZSxcbiAgICAgIC4uLihjdXJyZW50ICE9PSB1bmRlZmluZWQgJiYgeyBjdXJyZW50IH0pLFxuICAgICAgLi4uKGZpbHRlcnMgIT09IHVuZGVmaW5lZCAmJiB7IGZpbHRlcnMgfSksXG4gICAgICAuLi4ocmVzdWx0c1BlclBhZ2UgIT09IHVuZGVmaW5lZCAmJiB7IHJlc3VsdHNQZXJQYWdlIH0pLFxuICAgICAgLi4uKHNvcnREaXJlY3Rpb24gIT09IHVuZGVmaW5lZCAmJiB7IHNvcnREaXJlY3Rpb24gfSksXG4gICAgICAuLi4oc29ydEZpZWxkICE9PSB1bmRlZmluZWQgJiYgeyBzb3J0RmllbGQgfSksXG4gICAgICAuLi4oc29ydExpc3QgIT09IHVuZGVmaW5lZCAmJiB7IHNvcnRMaXN0IH0pXG4gICAgfSk7XG5cbiAgICBjb25zdCB3aXRoUXVlcnlDb25maWdPcHRpb25zID0ge1xuICAgICAgLi4ucmVzdE9mUXVlcnlDb25maWcsXG4gICAgICAuLi5vcHRpb25zRnJvbVN0YXRlXG4gICAgfTtcbiAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgLi4ucmVtb3ZlRW1wdHlGYWNldHNBbmRGaWx0ZXJzKHdpdGhRdWVyeUNvbmZpZ09wdGlvbnMpXG4gICAgfTtcblxuICAgIHJldHVybiB0aGlzLmJlZm9yZVNlYXJjaENhbGwob3B0aW9ucywgYXN5bmMgbmV3T3B0aW9ucyA9PiB7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuY2xpZW50LnNlYXJjaChxdWVyeSwgbmV3T3B0aW9ucyk7XG4gICAgICByZXR1cm4gYWRhcHRSZXNwb25zZShyZXNwb25zZSwgYnVpbGRSZXNwb25zZUFkYXB0ZXJPcHRpb25zKHF1ZXJ5Q29uZmlnKSk7XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBvbkF1dG9jb21wbGV0ZSh7IHNlYXJjaFRlcm0gfSwgcXVlcnlDb25maWcpIHtcbiAgICBjb25zdCBhdXRvY29tcGxldGVkU3RhdGUgPSB7fTtcbiAgICBsZXQgcHJvbWlzZXMgPSBbXTtcblxuICAgIGlmIChxdWVyeUNvbmZpZy5yZXN1bHRzKSB7XG4gICAgICBjb25zdCB7XG4gICAgICAgIGN1cnJlbnQsXG4gICAgICAgIGZpbHRlcnMsXG4gICAgICAgIHJlc3VsdHNQZXJQYWdlLFxuICAgICAgICBzb3J0RGlyZWN0aW9uLFxuICAgICAgICBzb3J0RmllbGQsXG4gICAgICAgIHNvcnRMaXN0LFxuICAgICAgICAuLi5yZXN0T2ZRdWVyeUNvbmZpZ1xuICAgICAgfSA9IHF1ZXJ5Q29uZmlnLnJlc3VsdHM7XG5cbiAgICAgIGNvbnN0IHsgcXVlcnksIC4uLm9wdGlvbnNGcm9tU3RhdGUgfSA9IGFkYXB0UmVxdWVzdCh7XG4gICAgICAgIGN1cnJlbnQsXG4gICAgICAgIHNlYXJjaFRlcm0sXG4gICAgICAgIGZpbHRlcnMsXG4gICAgICAgIHJlc3VsdHNQZXJQYWdlLFxuICAgICAgICBzb3J0RGlyZWN0aW9uLFxuICAgICAgICBzb3J0RmllbGQsXG4gICAgICAgIHNvcnRMaXN0XG4gICAgICB9KTtcblxuICAgICAgY29uc3Qgd2l0aFF1ZXJ5Q29uZmlnT3B0aW9ucyA9IHtcbiAgICAgICAgLi4ucmVzdE9mUXVlcnlDb25maWcsXG4gICAgICAgIC4uLm9wdGlvbnNGcm9tU3RhdGVcbiAgICAgIH07XG4gICAgICBjb25zdCBvcHRpb25zID0gcmVtb3ZlRW1wdHlGYWNldHNBbmRGaWx0ZXJzKHdpdGhRdWVyeUNvbmZpZ09wdGlvbnMpO1xuICAgICAgcHJvbWlzZXMucHVzaChcbiAgICAgICAgdGhpcy5iZWZvcmVBdXRvY29tcGxldGVSZXN1bHRzQ2FsbChvcHRpb25zLCBuZXdPcHRpb25zID0+IHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5jbGllbnQuc2VhcmNoKHF1ZXJ5LCBuZXdPcHRpb25zKS50aGVuKHJlc3BvbnNlID0+IHtcbiAgICAgICAgICAgIGF1dG9jb21wbGV0ZWRTdGF0ZS5hdXRvY29tcGxldGVkUmVzdWx0cyA9IGFkYXB0UmVzcG9uc2UoXG4gICAgICAgICAgICAgIHJlc3BvbnNlXG4gICAgICAgICAgICApLnJlc3VsdHM7XG4gICAgICAgICAgICBhdXRvY29tcGxldGVkU3RhdGUuYXV0b2NvbXBsZXRlZFJlc3VsdHNSZXF1ZXN0SWQgPVxuICAgICAgICAgICAgICByZXNwb25zZS5pbmZvLm1ldGEucmVxdWVzdF9pZDtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfVxuXG4gICAgaWYgKHF1ZXJ5Q29uZmlnLnN1Z2dlc3Rpb25zKSB7XG4gICAgICBjb25zdCBvcHRpb25zID0gcXVlcnlDb25maWcuc3VnZ2VzdGlvbnM7XG5cbiAgICAgIHByb21pc2VzLnB1c2goXG4gICAgICAgIHRoaXMuYmVmb3JlQXV0b2NvbXBsZXRlU3VnZ2VzdGlvbnNDYWxsKG9wdGlvbnMsIG5ld09wdGlvbnMgPT5cbiAgICAgICAgICB0aGlzLmNsaWVudC5xdWVyeVN1Z2dlc3Rpb24oc2VhcmNoVGVybSwgbmV3T3B0aW9ucykudGhlbihyZXNwb25zZSA9PiB7XG4gICAgICAgICAgICBhdXRvY29tcGxldGVkU3RhdGUuYXV0b2NvbXBsZXRlZFN1Z2dlc3Rpb25zID0gcmVzcG9uc2UucmVzdWx0cztcbiAgICAgICAgICAgIGF1dG9jb21wbGV0ZWRTdGF0ZS5hdXRvY29tcGxldGVkU3VnZ2VzdGlvbnNSZXF1ZXN0SWQgPVxuICAgICAgICAgICAgICByZXNwb25zZS5tZXRhLnJlcXVlc3RfaWQ7XG4gICAgICAgICAgfSlcbiAgICAgICAgKVxuICAgICAgKTtcbiAgICB9XG5cbiAgICBhd2FpdCBQcm9taXNlLmFsbChwcm9taXNlcyk7XG4gICAgcmV0dXJuIGF1dG9jb21wbGV0ZWRTdGF0ZTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBBcHBTZWFyY2hBUElDb25uZWN0b3I7XG4iXX0=