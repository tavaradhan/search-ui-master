"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _typeof = require("@babel/runtime/helpers/typeof");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var ElasticAppSearch = _interopRequireWildcard(require("@elastic/app-search-javascript"));

var _responseAdapter = require("./responseAdapter");

var _requestAdapters = require("./requestAdapters");

var _buildResponseAdapterOptions = _interopRequireDefault(require("./buildResponseAdapterOptions"));

var _excluded = ["facets", "filters"],
    _excluded2 = ["searchKey", "engineName", "hostIdentifier", "beforeSearchCall", "beforeAutocompleteResultsCall", "beforeAutocompleteSuggestionsCall", "endpointBase"],
    _excluded3 = ["current", "filters", "resultsPerPage", "sortDirection", "sortField", "sortList"],
    _excluded4 = ["query"],
    _excluded5 = ["current", "filters", "resultsPerPage", "sortDirection", "sortField", "sortList"],
    _excluded6 = ["query"];

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function _getRequireWildcardCache(nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || _typeof(obj) !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

// The API will error out if empty facets or filters objects
// are sent.
function removeEmptyFacetsAndFilters(options) {
  var facets = options.facets,
      filters = options.filters,
      rest = (0, _objectWithoutProperties2.default)(options, _excluded);
  return _objectSpread(_objectSpread(_objectSpread({}, facets && Object.entries(facets).length > 0 && {
    facets: facets
  }), filters && Object.entries(filters).length > 0 && {
    filters: filters
  }), rest);
}

var AppSearchAPIConnector = /*#__PURE__*/function () {
  /**
   * @callback next
   * @param {Object} updatedQueryOptions The options to send to the API
   */

  /**
   * @callback hook
   * @param {Object} queryOptions The options that are about to be sent to the API
   * @param {next} next The options that are about to be sent to the API
   */

  /**
   * @typedef Options
   * @param {string} searchKey Credential found in your App Search Dashboard
   * @param {string} engineName Engine to query, found in your App Search Dashboard
   * @param {string} hostIdentifier Credential found in your App Search Dashboard
   *  Useful when proxying the Swiftype API or developing against a local API server.
   * @param {hook} beforeSearchCall=(queryOptions,next)=>next(queryOptions) A hook to amend query options before the request is sent to the
   *   API in a query on an "onSearch" event.
   * @param {hook} beforeAutocompleteResultsCall=(queryOptions,next)=>next(queryOptions) A hook to amend query options before the request is sent to the
   *   API in a "results" query on an "onAutocomplete" event.
   * @param {hook} beforeAutocompleteSuggestionsCall=(queryOptions,next)=>next(queryOptions) A hook to amend query options before the request is sent to
   * the API in a "suggestions" query on an "onAutocomplete" event.
   * @param {string} endpointBase="" Overrides the base of the Swiftype API endpoint completely.
   */

  /**
   * @param {Options} options
   */
  function AppSearchAPIConnector(_ref) {
    var searchKey = _ref.searchKey,
        engineName = _ref.engineName,
        hostIdentifier = _ref.hostIdentifier,
        _ref$beforeSearchCall = _ref.beforeSearchCall,
        beforeSearchCall = _ref$beforeSearchCall === void 0 ? function (queryOptions, next) {
      return next(queryOptions);
    } : _ref$beforeSearchCall,
        _ref$beforeAutocomple = _ref.beforeAutocompleteResultsCall,
        beforeAutocompleteResultsCall = _ref$beforeAutocomple === void 0 ? function (queryOptions, next) {
      return next(queryOptions);
    } : _ref$beforeAutocomple,
        _ref$beforeAutocomple2 = _ref.beforeAutocompleteSuggestionsCall,
        beforeAutocompleteSuggestionsCall = _ref$beforeAutocomple2 === void 0 ? function (queryOptions, next) {
      return next(queryOptions);
    } : _ref$beforeAutocomple2,
        _ref$endpointBase = _ref.endpointBase,
        endpointBase = _ref$endpointBase === void 0 ? "" : _ref$endpointBase,
        rest = (0, _objectWithoutProperties2.default)(_ref, _excluded2);
    (0, _classCallCheck2.default)(this, AppSearchAPIConnector);

    if (!engineName || !(hostIdentifier || endpointBase)) {
      throw Error("hostIdentifier or endpointBase, and engineName are required");
    }

    this.client = ElasticAppSearch.createClient(_objectSpread(_objectSpread(_objectSpread({}, endpointBase && {
      endpointBase: endpointBase
    }), hostIdentifier && {
      hostIdentifier: hostIdentifier
    }), {}, {
      apiKey: searchKey,
      engineName: engineName
    }, rest));
    this.beforeSearchCall = beforeSearchCall;
    this.beforeAutocompleteResultsCall = beforeAutocompleteResultsCall;
    this.beforeAutocompleteSuggestionsCall = beforeAutocompleteSuggestionsCall;
  }

  (0, _createClass2.default)(AppSearchAPIConnector, [{
    key: "onResultClick",
    value: function onResultClick(_ref2) {
      var query = _ref2.query,
          documentId = _ref2.documentId,
          requestId = _ref2.requestId,
          _ref2$tags = _ref2.tags,
          tags = _ref2$tags === void 0 ? [] : _ref2$tags;
      tags = tags.concat("results");
      return this.client.click({
        query: query,
        documentId: documentId,
        requestId: requestId,
        tags: tags
      });
    }
  }, {
    key: "onAutocompleteResultClick",
    value: function onAutocompleteResultClick(_ref3) {
      var query = _ref3.query,
          documentId = _ref3.documentId,
          requestId = _ref3.requestId,
          _ref3$tags = _ref3.tags,
          tags = _ref3$tags === void 0 ? [] : _ref3$tags;
      tags = tags.concat("autocomplete");
      return this.client.click({
        query: query,
        documentId: documentId,
        requestId: requestId,
        tags: tags
      });
    }
  }, {
    key: "onSearch",
    value: function () {
      var _onSearch = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee2(state, queryConfig) {
        var _this = this;

        var current, filters, resultsPerPage, sortDirection, sortField, sortList, restOfQueryConfig, _adaptRequest, query, optionsFromState, withQueryConfigOptions, options;

        return _regenerator.default.wrap(function _callee2$(_context2) {
          while (1) {
            switch (_context2.prev = _context2.next) {
              case 0:
                current = queryConfig.current, filters = queryConfig.filters, resultsPerPage = queryConfig.resultsPerPage, sortDirection = queryConfig.sortDirection, sortField = queryConfig.sortField, sortList = queryConfig.sortList, restOfQueryConfig = (0, _objectWithoutProperties2.default)(queryConfig, _excluded3);
                _adaptRequest = (0, _requestAdapters.adaptRequest)(_objectSpread(_objectSpread(_objectSpread(_objectSpread(_objectSpread(_objectSpread(_objectSpread({}, state), current !== undefined && {
                  current: current
                }), filters !== undefined && {
                  filters: filters
                }), resultsPerPage !== undefined && {
                  resultsPerPage: resultsPerPage
                }), sortDirection !== undefined && {
                  sortDirection: sortDirection
                }), sortField !== undefined && {
                  sortField: sortField
                }), sortList !== undefined && {
                  sortList: sortList
                })), query = _adaptRequest.query, optionsFromState = (0, _objectWithoutProperties2.default)(_adaptRequest, _excluded4);
                withQueryConfigOptions = _objectSpread(_objectSpread({}, restOfQueryConfig), optionsFromState);
                options = _objectSpread({}, removeEmptyFacetsAndFilters(withQueryConfigOptions));
                return _context2.abrupt("return", this.beforeSearchCall(options, /*#__PURE__*/function () {
                  var _ref4 = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee(newOptions) {
                    var response;
                    return _regenerator.default.wrap(function _callee$(_context) {
                      while (1) {
                        switch (_context.prev = _context.next) {
                          case 0:
                            _context.next = 2;
                            return _this.client.search(query, newOptions);

                          case 2:
                            response = _context.sent;
                            return _context.abrupt("return", (0, _responseAdapter.adaptResponse)(response, (0, _buildResponseAdapterOptions.default)(queryConfig)));

                          case 4:
                          case "end":
                            return _context.stop();
                        }
                      }
                    }, _callee);
                  }));

                  return function (_x3) {
                    return _ref4.apply(this, arguments);
                  };
                }()));

              case 5:
              case "end":
                return _context2.stop();
            }
          }
        }, _callee2, this);
      }));

      function onSearch(_x, _x2) {
        return _onSearch.apply(this, arguments);
      }

      return onSearch;
    }()
  }, {
    key: "onAutocomplete",
    value: function () {
      var _onAutocomplete = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee3(_ref5, queryConfig) {
        var _this2 = this;

        var searchTerm, autocompletedState, promises, _queryConfig$results, current, filters, resultsPerPage, sortDirection, sortField, sortList, restOfQueryConfig, _adaptRequest2, query, optionsFromState, withQueryConfigOptions, options, _options;

        return _regenerator.default.wrap(function _callee3$(_context3) {
          while (1) {
            switch (_context3.prev = _context3.next) {
              case 0:
                searchTerm = _ref5.searchTerm;
                autocompletedState = {};
                promises = [];

                if (queryConfig.results) {
                  _queryConfig$results = queryConfig.results, current = _queryConfig$results.current, filters = _queryConfig$results.filters, resultsPerPage = _queryConfig$results.resultsPerPage, sortDirection = _queryConfig$results.sortDirection, sortField = _queryConfig$results.sortField, sortList = _queryConfig$results.sortList, restOfQueryConfig = (0, _objectWithoutProperties2.default)(_queryConfig$results, _excluded5);
                  _adaptRequest2 = (0, _requestAdapters.adaptRequest)({
                    current: current,
                    searchTerm: searchTerm,
                    filters: filters,
                    resultsPerPage: resultsPerPage,
                    sortDirection: sortDirection,
                    sortField: sortField,
                    sortList: sortList
                  }), query = _adaptRequest2.query, optionsFromState = (0, _objectWithoutProperties2.default)(_adaptRequest2, _excluded6);
                  withQueryConfigOptions = _objectSpread(_objectSpread({}, restOfQueryConfig), optionsFromState);
                  options = removeEmptyFacetsAndFilters(withQueryConfigOptions);
                  promises.push(this.beforeAutocompleteResultsCall(options, function (newOptions) {
                    return _this2.client.search(query, newOptions).then(function (response) {
                      autocompletedState.autocompletedResults = (0, _responseAdapter.adaptResponse)(response).results;
                      autocompletedState.autocompletedResultsRequestId = response.info.meta.request_id;
                    });
                  }));
                }

                if (queryConfig.suggestions) {
                  _options = queryConfig.suggestions;
                  promises.push(this.beforeAutocompleteSuggestionsCall(_options, function (newOptions) {
                    return _this2.client.querySuggestion(searchTerm, newOptions).then(function (response) {
                      autocompletedState.autocompletedSuggestions = response.results;
                      autocompletedState.autocompletedSuggestionsRequestId = response.meta.request_id;
                    });
                  }));
                }

                _context3.next = 7;
                return Promise.all(promises);

              case 7:
                return _context3.abrupt("return", autocompletedState);

              case 8:
              case "end":
                return _context3.stop();
            }
          }
        }, _callee3, this);
      }));

      function onAutocomplete(_x4, _x5) {
        return _onAutocomplete.apply(this, arguments);
      }

      return onAutocomplete;
    }()
  }]);
  return AppSearchAPIConnector;
}();

var _default = AppSearchAPIConnector;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9BcHBTZWFyY2hBUElDb25uZWN0b3IuanMiXSwibmFtZXMiOlsicmVtb3ZlRW1wdHlGYWNldHNBbmRGaWx0ZXJzIiwib3B0aW9ucyIsImZhY2V0cyIsImZpbHRlcnMiLCJyZXN0IiwiT2JqZWN0IiwiZW50cmllcyIsImxlbmd0aCIsIkFwcFNlYXJjaEFQSUNvbm5lY3RvciIsInNlYXJjaEtleSIsImVuZ2luZU5hbWUiLCJob3N0SWRlbnRpZmllciIsImJlZm9yZVNlYXJjaENhbGwiLCJxdWVyeU9wdGlvbnMiLCJuZXh0IiwiYmVmb3JlQXV0b2NvbXBsZXRlUmVzdWx0c0NhbGwiLCJiZWZvcmVBdXRvY29tcGxldGVTdWdnZXN0aW9uc0NhbGwiLCJlbmRwb2ludEJhc2UiLCJFcnJvciIsImNsaWVudCIsIkVsYXN0aWNBcHBTZWFyY2giLCJjcmVhdGVDbGllbnQiLCJhcGlLZXkiLCJxdWVyeSIsImRvY3VtZW50SWQiLCJyZXF1ZXN0SWQiLCJ0YWdzIiwiY29uY2F0IiwiY2xpY2siLCJzdGF0ZSIsInF1ZXJ5Q29uZmlnIiwiY3VycmVudCIsInJlc3VsdHNQZXJQYWdlIiwic29ydERpcmVjdGlvbiIsInNvcnRGaWVsZCIsInNvcnRMaXN0IiwicmVzdE9mUXVlcnlDb25maWciLCJ1bmRlZmluZWQiLCJvcHRpb25zRnJvbVN0YXRlIiwid2l0aFF1ZXJ5Q29uZmlnT3B0aW9ucyIsIm5ld09wdGlvbnMiLCJzZWFyY2giLCJyZXNwb25zZSIsInNlYXJjaFRlcm0iLCJhdXRvY29tcGxldGVkU3RhdGUiLCJwcm9taXNlcyIsInJlc3VsdHMiLCJwdXNoIiwidGhlbiIsImF1dG9jb21wbGV0ZWRSZXN1bHRzIiwiYXV0b2NvbXBsZXRlZFJlc3VsdHNSZXF1ZXN0SWQiLCJpbmZvIiwibWV0YSIsInJlcXVlc3RfaWQiLCJzdWdnZXN0aW9ucyIsInF1ZXJ5U3VnZ2VzdGlvbiIsImF1dG9jb21wbGV0ZWRTdWdnZXN0aW9ucyIsImF1dG9jb21wbGV0ZWRTdWdnZXN0aW9u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QVEsRUFBSTtBQUM1REUsc0JBQUFBLGtCQUFrQixDQUFDSyxvQkFBbkIsR0FBMEMsb0NBQ3hDUCxRQUR3QyxFQUV4Q0ksT0FGRjtBQUdBRixzQkFBQUEsa0JBQWtCLENBQUNNLDZCQUFuQixHQUNFUixRQUFRLENBQUNTLElBQVQsQ0FBY0MsSUFBZCxDQUFtQkMsVUFEckI7QUFFRCxxQkFOTSxDQUFQO0FBT0QsbUJBUkQsQ0FERjtBQVdEOztBQUVELG9CQUFJdkIsV0FBVyxDQUFDd0IsV0FBaEIsRUFBNkI7QUFDckJyRCxrQkFBQUEsUUFEcUIsR0FDWDZCLFdBQVcsQ0FBQ3dCLFdBREQ7QUFHM0JULGtCQUFBQSxRQUFRLENBQUNFLElBQVQsQ0FDRSxLQUFLL0IsaUNBQUwsQ0FBdUNmLFFBQXZDLEVBQWdELFVBQUF1QyxVQUFVO0FBQUEsMkJBQ3hELE1BQUksQ0FBQ3JCLE1BQUwsQ0FBWW9DLGVBQVosQ0FBNEJaLFVBQTVCLEVBQXdDSCxVQUF4QyxFQUFvRFEsSUFBcEQsQ0FBeUQsVUFBQU4sUUFBUSxFQUFJO0FBQ25FRSxzQkFBQUEsa0JBQWtCLENBQUNZLHdCQUFuQixHQUE4Q2QsUUFBUSxDQUFDSSxPQUF2RDtBQUNBRixzQkFBQUEsa0JBQWtCLENBQUNhLGlDQUFuQixHQUNFZixRQUFRLENBQUNVLElBQVQsQ0FBY0MsVUFEaEI7QUFFRCxxQkFKRCxDQUR3RDtBQUFBLG1CQUExRCxDQURGO0FBU0Q7O0FBdkRIO0FBQUEsdUJBeURRSyxPQUFPLENBQUNDLEdBQVIsQ0FBWWQsUUFBWixDQXpEUjs7QUFBQTtBQUFBLGtEQTBEU0Qsa0JBMURUOztBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBLE87Ozs7Ozs7Ozs7OztlQThEYXBDLHFCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgRWxhc3RpY0FwcFNlYXJjaCBmcm9tIFwiQGVsYXN0aWMvYXBwLXNlYXJjaC1qYXZhc2NyaXB0XCI7XG5cbmltcG9ydCB7IGFkYXB0UmVzcG9uc2UgfSBmcm9tIFwiLi9yZXNwb25zZUFkYXB0ZXJcIjtcbmltcG9ydCB7IGFkYXB0UmVxdWVzdCB9IGZyb20gXCIuL3JlcXVlc3RBZGFwdGVyc1wiO1xuaW1wb3J0IGJ1aWxkUmVzcG9uc2VBZGFwdGVyT3B0aW9ucyBmcm9tIFwiLi9idWlsZFJlc3BvbnNlQWRhcHRlck9wdGlvbnNcIjtcblxuLy8gVGhlIEFQSSB3aWxsIGVycm9yIG91dCBpZiBlbXB0eSBmYWNldHMgb3IgZmlsdGVycyBvYmplY3RzXG4vLyBhcmUgc2VudC5cbmZ1bmN0aW9uIHJlbW92ZUVtcHR5RmFjZXRzQW5kRmlsdGVycyhvcHRpb25zKSB7XG4gIGNvbnN0IHsgZmFjZXRzLCBmaWx0ZXJzLCAuLi5yZXN0IH0gPSBvcHRpb25zO1xuICByZXR1cm4ge1xuICAgIC4uLihmYWNldHMgJiYgT2JqZWN0LmVudHJpZXMoZmFjZXRzKS5sZW5ndGggPiAwICYmIHsgZmFjZXRzIH0pLFxuICAgIC4uLihmaWx0ZXJzICYmIE9iamVjdC5lbnRyaWVzKGZpbHRlcnMpLmxlbmd0aCA+IDAgJiYgeyBmaWx0ZXJzIH0pLFxuICAgIC4uLnJlc3RcbiAgfTtcbn1cbmNsYXNzIEFwcFNlYXJjaEFQSUNvbm5lY3RvciB7XG4gIC8qKlxuICAgKiBAY2FsbGJhY2sgbmV4dFxuICAgKiBAcGFyYW0ge09iamVjdH0gdXBkYXRlZFF1ZXJ5T3B0aW9ucyBUaGUgb3B0aW9ucyB0byBzZW5kIHRvIHRoZSBBUElcbiAgICovXG5cbiAgLyoqXG4gICAqIEBjYWxsYmFjayBob29rXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBxdWVyeU9wdGlvbnMgVGhlIG9wdGlvbnMgdGhhdCBhcmUgYWJvdXQgdG8gYmUgc2VudCB0byB0aGUgQVBJXG4gICAqIEBwYXJhbSB7bmV4dH0gbmV4dCBUaGUgb3B0aW9ucyB0aGF0IGFyZSBhYm91dCB0byBiZSBzZW50IHRvIHRoZSBBUElcbiAgICovXG5cbiAgLyoqXG4gICAqIEB0eXBlZGVmIE9wdGlvbnNcbiAgICogQHBhcmFtIHtzdHJpbmd9IHNlYXJjaEtleSBDcmVkZW50aWFsIGZvdW5kIGluIHlvdXIgQXBwIFNlYXJjaCBEYXNoYm9hcmRcbiAgICogQHBhcmFtIHtzdHJpbmd9IGVuZ2luZU5hbWUgRW5naW5lIHRvIHF1ZXJ5LCBmb3VuZCBpbiB5b3VyIEFwcCBTZWFyY2ggRGFzaGJvYXJkXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBob3N0SWRlbnRpZmllciBDcmVkZW50aWFsIGZvdW5kIGluIHlvdXIgQXBwIFNlYXJjaCBEYXNoYm9hcmRcbiAgICogIFVzZWZ1bCB3aGVuIHByb3h5aW5nIHRoZSBTd2lmdHlwZSBBUEkgb3IgZGV2ZWxvcGluZyBhZ2FpbnN0IGEgbG9jYWwgQVBJIHNlcnZlci5cbiAgICogQHBhcmFtIHtob29rfSBiZWZvcmVTZWFyY2hDYWxsPShxdWVyeU9wdGlvbnMsbmV4dCk9Pm5leHQocXVlcnlPcHRpb25zKSBBIGhvb2sgdG8gYW1lbmQgcXVlcnkgb3B0aW9ucyBiZWZvcmUgdGhlIHJlcXVlc3QgaXMgc2VudCB0byB0aGVcbiAgICogICBBUEkgaW4gYSBxdWVyeSBvbiBhbiBcIm9uU2VhcmNoXCIgZXZlbnQuXG4gICAqIEBwYXJhbSB7aG9va30gYmVmb3JlQXV0b2NvbXBsZXRlUmVzdWx0c0NhbGw9KHF1ZXJ5T3B0aW9ucyxuZXh0KT0+bmV4dChxdWVyeU9wdGlvbnMpIEEgaG9vayB0byBhbWVuZCBxdWVyeSBvcHRpb25zIGJlZm9yZSB0aGUgcmVxdWVzdCBpcyBzZW50IHRvIHRoZVxuICAgKiAgIEFQSSBpbiBhIFwicmVzdWx0c1wiIHF1ZXJ5IG9uIGFuIFwib25BdXRvY29tcGxldGVcIiBldmVudC5cbiAgICogQHBhcmFtIHtob29rfSBiZWZvcmVBdXRvY29tcGxldGVTdWdnZXN0aW9uc0NhbGw9KHF1ZXJ5T3B0aW9ucyxuZXh0KT0+bmV4dChxdWVyeU9wdGlvbnMpIEEgaG9vayB0byBhbWVuZCBxdWVyeSBvcHRpb25zIGJlZm9yZSB0aGUgcmVxdWVzdCBpcyBzZW50IHRvXG4gICAqIHRoZSBBUEkgaW4gYSBcInN1Z2dlc3Rpb25zXCIgcXVlcnkgb24gYW4gXCJvbkF1dG9jb21wbGV0ZVwiIGV2ZW50LlxuICAgKiBAcGFyYW0ge3N0cmluZ30gZW5kcG9pbnRCYXNlPVwiXCIgT3ZlcnJpZGVzIHRoZSBiYXNlIG9mIHRoZSBTd2lmdHlwZSBBUEkgZW5kcG9pbnQgY29tcGxldGVseS5cbiAgICovXG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7T3B0aW9uc30gb3B0aW9uc1xuICAgKi9cbiAgY29uc3RydWN0b3Ioe1xuICAgIHNlYXJjaEtleSxcbiAgICBlbmdpbmVOYW1lLFxuICAgIGhvc3RJZGVudGlmaWVyLFxuICAgIGJlZm9yZVNlYXJjaENhbGwgPSAocXVlcnlPcHRpb25zLCBuZXh0KSA9PiBuZXh0KHF1ZXJ5T3B0aW9ucyksXG4gICAgYmVmb3JlQXV0b2NvbXBsZXRlUmVzdWx0c0NhbGwgPSAocXVlcnlPcHRpb25zLCBuZXh0KSA9PiBuZXh0KHF1ZXJ5T3B0aW9ucyksXG4gICAgYmVmb3JlQXV0b2NvbXBsZXRlU3VnZ2VzdGlvbnNDYWxsID0gKHF1ZXJ5T3B0aW9ucywgbmV4dCkgPT5cbiAgICAgIG5leHQocXVlcnlPcHRpb25zKSxcbiAgICBlbmRwb2ludEJhc2UgPSBcIlwiLFxuICAgIC4uLnJlc3RcbiAgfSkge1xuICAgIGlmICghZW5naW5lTmFtZSB8fCAhKGhvc3RJZGVudGlmaWVyIHx8IGVuZHBvaW50QmFzZSkpIHtcbiAgICAgIHRocm93IEVycm9yKFxuICAgICAgICBcImhvc3RJZGVudGlmaWVyIG9yIGVuZHBvaW50QmFzZSwgYW5kIGVuZ2luZU5hbWUgYXJlIHJlcXVpcmVkXCJcbiAgICAgICk7XG4gICAgfVxuXG4gICAgdGhpcy5jbGllbnQgPSBFbGFzdGljQXBwU2VhcmNoLmNyZWF0ZUNsaWVudCh7XG4gICAgICAuLi4oZW5kcG9pbnRCYXNlICYmIHsgZW5kcG9pbnRCYXNlIH0pLCAvL0FkZCBwcm9wZXJ0eSBvbiBjb25kaXRpb25cbiAgICAgIC4uLihob3N0SWRlbnRpZmllciAmJiB7IGhvc3RJZGVudGlmaWVyOiBob3N0SWRlbnRpZmllciB9KSxcbiAgICAgIGFwaUtleTogc2VhcmNoS2V5LFxuICAgICAgZW5naW5lTmFtZTogZW5naW5lTmFtZSxcbiAgICAgIC4uLnJlc3RcbiAgICB9KTtcbiAgICB0aGlzLmJlZm9yZVNlYXJjaENhbGwgPSBiZWZvcmVTZWFyY2hDYWxsO1xuICAgIHRoaXMuYmVmb3JlQXV0b2NvbXBsZXRlUmVzdWx0c0NhbGwgPSBiZWZvcmVBdXRvY29tcGxldGVSZXN1bHRzQ2FsbDtcbiAgICB0aGlzLmJlZm9yZUF1dG9jb21wbGV0ZVN1Z2dlc3Rpb25zQ2FsbCA9IGJlZm9yZUF1dG9jb21wbGV0ZVN1Z2dlc3Rpb25zQ2FsbDtcbiAgfVxuXG4gIG9uUmVzdWx0Q2xpY2soeyBxdWVyeSwgZG9jdW1lbnRJZCwgcmVxdWVzdElkLCB0YWdzID0gW10gfSkge1xuICAgIHRhZ3MgPSB0YWdzLmNvbmNhdChcInJlc3VsdHNcIik7XG4gICAgcmV0dXJuIHRoaXMuY2xpZW50LmNsaWNrKHsgcXVlcnksIGRvY3VtZW50SWQsIHJlcXVlc3RJZCwgdGFncyB9KTtcbiAgfVxuXG4gIG9uQXV0b2NvbXBsZXRlUmVzdWx0Q2xpY2soeyBxdWVyeSwgZG9jdW1lbnRJZCwgcmVxdWVzdElkLCB0YWdzID0gW10gfSkge1xuICAgIHRhZ3MgPSB0YWdzLmNvbmNhdChcImF1dG9jb21wbGV0ZVwiKTtcbiAgICByZXR1cm4gdGhpcy5jbGllbnQuY2xpY2soeyBxdWVyeSwgZG9jdW1lbnRJZCwgcmVxdWVzdElkLCB0YWdzIH0pO1xuICB9XG5cbiAgYXN5bmMgb25TZWFyY2goc3RhdGUsIHF1ZXJ5Q29uZmlnKSB7XG4gICAgY29uc3Qge1xuICAgICAgY3VycmVudCxcbiAgICAgIGZpbHRlcnMsXG4gICAgICByZXN1bHRzUGVyUGFnZSxcbiAgICAgIHNvcnREaXJlY3Rpb24sXG4gICAgICBzb3J0RmllbGQsXG4gICAgICBzb3J0TGlzdCxcbiAgICAgIC4uLnJlc3RPZlF1ZXJ5Q29uZmlnXG4gICAgfSA9IHF1ZXJ5Q29uZmlnO1xuXG4gICAgY29uc3QgeyBxdWVyeSwgLi4ub3B0aW9uc0Zyb21TdGF0ZSB9ID0gYWRhcHRSZXF1ZXN0KHtcbiAgICAgIC4uLnN0YXRlLFxuICAgICAgLi4uKGN1cnJlbnQgIT09IHVuZGVmaW5lZCAmJiB7IGN1cnJlbnQgfSksXG4gICAgICAuLi4oZmlsdGVycyAhPT0gdW5kZWZpbmVkICYmIHsgZmlsdGVycyB9KSxcbiAgICAgIC4uLihyZXN1bHRzUGVyUGFnZSAhPT0gdW5kZWZpbmVkICYmIHsgcmVzdWx0c1BlclBhZ2UgfSksXG4gICAgICAuLi4oc29ydERpcmVjdGlvbiAhPT0gdW5kZWZpbmVkICYmIHsgc29ydERpcmVjdGlvbiB9KSxcbiAgICAgIC4uLihzb3J0RmllbGQgIT09IHVuZGVmaW5lZCAmJiB7IHNvcnRGaWVsZCB9KSxcbiAgICAgIC4uLihzb3J0TGlzdCAhPT0gdW5kZWZpbmVkICYmIHsgc29ydExpc3QgfSlcbiAgICB9KTtcblxuICAgIGNvbnN0IHdpdGhRdWVyeUNvbmZpZ09wdGlvbnMgPSB7XG4gICAgICAuLi5yZXN0T2ZRdWVyeUNvbmZpZyxcbiAgICAgIC4uLm9wdGlvbnNGcm9tU3RhdGVcbiAgICB9O1xuICAgIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgICAuLi5yZW1vdmVFbXB0eUZhY2V0c0FuZEZpbHRlcnMod2l0aFF1ZXJ5Q29uZmlnT3B0aW9ucylcbiAgICB9O1xuXG4gICAgcmV0dXJuIHRoaXMuYmVmb3JlU2VhcmNoQ2FsbChvcHRpb25zLCBhc3luYyBuZXdPcHRpb25zID0+IHtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5jbGllbnQuc2VhcmNoKHF1ZXJ5LCBuZXdPcHRpb25zKTtcbiAgICAgIHJldHVybiBhZGFwdFJlc3BvbnNlKHJlc3BvbnNlLCBidWlsZFJlc3BvbnNlQWRhcHRlck9wdGlvbnMocXVlcnlDb25maWcpKTtcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIG9uQXV0b2NvbXBsZXRlKHsgc2VhcmNoVGVybSB9LCBxdWVyeUNvbmZpZykge1xuICAgIGNvbnN0IGF1dG9jb21wbGV0ZWRTdGF0ZSA9IHt9O1xuICAgIGxldCBwcm9taXNlcyA9IFtdO1xuXG4gICAgaWYgKHF1ZXJ5Q29uZmlnLnJlc3VsdHMpIHtcbiAgICAgIGNvbnN0IHtcbiAgICAgICAgY3VycmVudCxcbiAgICAgICAgZmlsdGVycyxcbiAgICAgICAgcmVzdWx0c1BlclBhZ2UsXG4gICAgICAgIHNvcnREaXJlY3Rpb24sXG4gICAgICAgIHNvcnRGaWVsZCxcbiAgICAgICAgc29ydExpc3QsXG4gICAgICAgIC4uLnJlc3RPZlF1ZXJ5Q29uZmlnXG4gICAgICB9ID0gcXVlcnlDb25maWcucmVzdWx0cztcblxuICAgICAgY29uc3QgeyBxdWVyeSwgLi4ub3B0aW9uc0Zyb21TdGF0ZSB9ID0gYWRhcHRSZXF1ZXN0KHtcbiAgICAgICAgY3VycmVudCxcbiAgICAgICAgc2VhcmNoVGVybSxcbiAgICAgICAgZmlsdGVycyxcbiAgICAgICAgcmVzdWx0c1BlclBhZ2UsXG4gICAgICAgIHNvcnREaXJlY3Rpb24sXG4gICAgICAgIHNvcnRGaWVsZCxcbiAgICAgICAgc29ydExpc3RcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCB3aXRoUXVlcnlDb25maWdPcHRpb25zID0ge1xuICAgICAgICAuLi5yZXN0T2ZRdWVyeUNvbmZpZyxcbiAgICAgICAgLi4ub3B0aW9uc0Zyb21TdGF0ZVxuICAgICAgfTtcbiAgICAgIGNvbnN0IG9wdGlvbnMgPSByZW1vdmVFbXB0eUZhY2V0c0FuZEZpbHRlcnMod2l0aFF1ZXJ5Q29uZmlnT3B0aW9ucyk7XG4gICAgICBwcm9taXNlcy5wdXNoKFxuICAgICAgICB0aGlzLmJlZm9yZUF1dG9jb21wbGV0ZVJlc3VsdHNDYWxsKG9wdGlvbnMsIG5ld09wdGlvbnMgPT4ge1xuICAgICAgICAgIHJldHVybiB0aGlzLmNsaWVudC5zZWFyY2gocXVlcnksIG5ld09wdGlvbnMpLnRoZW4ocmVzcG9uc2UgPT4ge1xuICAgICAgICAgICAgYXV0b2NvbXBsZXRlZFN0YXRlLmF1dG9jb21wbGV0ZWRSZXN1bHRzID0gYWRhcHRSZXNwb25zZShcbiAgICAgICAgICAgICAgcmVzcG9uc2VcbiAgICAgICAgICAgICkucmVzdWx0cztcbiAgICAgICAgICAgIGF1dG9jb21wbGV0ZWRTdGF0ZS5hdXRvY29tcGxldGVkUmVzdWx0c1JlcXVlc3RJZCA9XG4gICAgICAgICAgICAgIHJlc3BvbnNlLmluZm8ubWV0YS5yZXF1ZXN0X2lkO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAocXVlcnlDb25maWcuc3VnZ2VzdGlvbnMpIHtcbiAgICAgIGNvbnN0IG9wdGlvbnMgPSBxdWVyeUNvbmZpZy5zdWdnZXN0aW9ucztcblxuICAgICAgcHJvbWlzZXMucHVzaChcbiAgICAgICAgdGhpcy5iZWZvcmVBdXRvY29tcGxldGVTdWdnZXN0aW9uc0NhbGwob3B0aW9ucywgbmV3T3B0aW9ucyA9PlxuICAgICAgICAgIHRoaXMuY2xpZW50LnF1ZXJ5U3VnZ2VzdGlvbihzZWFyY2hUZXJtLCBuZXdPcHRpb25zKS50aGVuKHJlc3BvbnNlID0+IHtcbiAgICAgICAgICAgIGF1dG9jb21wbGV0ZWRTdGF0ZS5hdXRvY29tcGxldGVkU3VnZ2VzdGlvbnMgPSByZXNwb25zZS5yZXN1bHRzO1xuICAgICAgICAgICAgYXV0b2NvbXBsZXRlZFN0YXRlLmF1dG9jb21wbGV0ZWRTdWdnZXN0aW9uc1JlcXVlc3RJZCA9XG4gICAgICAgICAgICAgIHJlc3BvbnNlLm1ldGEucmVxdWVzdF9pZDtcbiAgICAgICAgICB9KVxuICAgICAgICApXG4gICAgICApO1xuICAgIH1cblxuICAgIGF3YWl0IFByb21pc2UuYWxsKHByb21pc2VzKTtcbiAgICByZXR1cm4gYXV0b2NvbXBsZXRlZFN0YXRlO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IEFwcFNlYXJjaEFQSUNvbm5lY3RvcjtcbiJdfQ==