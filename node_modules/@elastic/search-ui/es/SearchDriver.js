import _objectWithoutProperties from "@babel/runtime/helpers/objectWithoutProperties";
import _classCallCheck from "@babel/runtime/helpers/classCallCheck";
import _createClass from "@babel/runtime/helpers/createClass";
import _defineProperty from "@babel/runtime/helpers/defineProperty";
import _slicedToArray from "@babel/runtime/helpers/slicedToArray";
var _excluded = ["filters", "conditionalFacets"];

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

import URLManager from "./URLManager";
import RequestSequencer from "./RequestSequencer";
import DebounceManager from "./DebounceManager";
import * as actions from "./actions";
import Events from "./Events";
import { mergeFilters } from "./helpers";
import * as a11y from "./A11yNotifications";

function filterSearchParameters(_ref) {
  var current = _ref.current,
      filters = _ref.filters,
      resultsPerPage = _ref.resultsPerPage,
      searchTerm = _ref.searchTerm,
      sortDirection = _ref.sortDirection,
      sortField = _ref.sortField,
      sortList = _ref.sortList;
  return {
    current: current,
    filters: filters,
    resultsPerPage: resultsPerPage,
    searchTerm: searchTerm,
    sortDirection: sortDirection,
    sortField: sortField,
    sortList: sortList
  };
}

export var DEFAULT_STATE = {
  // Search Parameters -- This is state that represents the input state.
  current: 1,
  filters: [],
  resultsPerPage: 20,
  searchTerm: "",
  sortDirection: "",
  sortField: "",
  sortList: [],
  // Result State -- This state represents state that is updated automatically
  // as the result of changing input state.
  autocompletedResults: [],
  autocompletedResultsRequestId: "",
  autocompletedSuggestions: {},
  autocompletedSuggestionsRequestId: "",
  error: "",
  isLoading: false,
  facets: {},
  requestId: "",
  results: [],
  resultSearchTerm: "",
  totalPages: 0,
  totalResults: 0,
  pagingStart: 0,
  pagingEnd: 0,
  wasSearched: false,
  rawResponse: {}
};

function removeConditionalFacets() {
  var facets = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
  var conditionalFacets = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
  var filters = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : [];
  return Object.entries(facets).reduce(function (acc, _ref2) {
    var _ref3 = _slicedToArray(_ref2, 2),
        facetKey = _ref3[0],
        facet = _ref3[1];

    if (conditionalFacets[facetKey] && typeof conditionalFacets[facetKey] === "function" && !conditionalFacets[facetKey]({
      filters: filters
    })) {
      return acc;
    }

    acc[facetKey] = facet;
    return acc;
  }, {});
}
/*
 * The Driver is a framework agnostic search state manager that is capable
 * syncing state to the url.
 */


var SearchDriver = /*#__PURE__*/function () {
  function SearchDriver(_ref4) {
    var _this = this;

    var apiConnector = _ref4.apiConnector,
        _ref4$autocompleteQue = _ref4.autocompleteQuery,
        autocompleteQuery = _ref4$autocompleteQue === void 0 ? {} : _ref4$autocompleteQue,
        debug = _ref4.debug,
        initialState = _ref4.initialState,
        onSearch = _ref4.onSearch,
        onAutocomplete = _ref4.onAutocomplete,
        onResultClick = _ref4.onResultClick,
        onAutocompleteResultClick = _ref4.onAutocompleteResultClick,
        _ref4$searchQuery = _ref4.searchQuery,
        searchQuery = _ref4$searchQuery === void 0 ? {} : _ref4$searchQuery,
        _ref4$trackUrlState = _ref4.trackUrlState,
        trackUrlState = _ref4$trackUrlState === void 0 ? true : _ref4$trackUrlState,
        _ref4$urlPushDebounce = _ref4.urlPushDebounceLength,
        urlPushDebounceLength = _ref4$urlPushDebounce === void 0 ? 500 : _ref4$urlPushDebounce,
        _ref4$hasA11yNotifica = _ref4.hasA11yNotifications,
        hasA11yNotifications = _ref4$hasA11yNotifica === void 0 ? false : _ref4$hasA11yNotifica,
        _ref4$a11yNotificatio = _ref4.a11yNotificationMessages,
        a11yNotificationMessages = _ref4$a11yNotificatio === void 0 ? {} : _ref4$a11yNotificatio,
        _ref4$alwaysSearchOnI = _ref4.alwaysSearchOnInitialLoad,
        alwaysSearchOnInitialLoad = _ref4$alwaysSearchOnI === void 0 ? false : _ref4$alwaysSearchOnI;

    _classCallCheck(this, SearchDriver);

    _defineProperty(this, "state", DEFAULT_STATE);

    _defineProperty(this, "_updateAutocomplete", function (searchTerm) {
      var _ref5 = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {},
          autocompleteResults = _ref5.autocompleteResults,
          autocompleteSuggestions = _ref5.autocompleteSuggestions;

      var requestId = _this.autocompleteRequestSequencer.next();

      var queryConfig = _objectSpread(_objectSpread({}, autocompleteResults && {
        results: _this.autocompleteQuery.results || {}
      }), autocompleteSuggestions && {
        suggestions: _this.autocompleteQuery.suggestions || {}
      });

      return _this.events.autocomplete({
        searchTerm: searchTerm
      }, queryConfig).then(function (autocompleted) {
        if (_this.autocompleteRequestSequencer.isOldRequest(requestId)) return;

        _this.autocompleteRequestSequencer.completed(requestId);

        _this._setState(autocompleted);
      });
    });

    _defineProperty(this, "_updateSearchResults", function (searchParameters) {
      var _ref6 = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {},
          _ref6$skipPushToUrl = _ref6.skipPushToUrl,
          skipPushToUrl = _ref6$skipPushToUrl === void 0 ? false : _ref6$skipPushToUrl,
          _ref6$replaceUrl = _ref6.replaceUrl,
          replaceUrl = _ref6$replaceUrl === void 0 ? false : _ref6$replaceUrl;

      var _this$state$searchPar = _objectSpread(_objectSpread({}, _this.state), searchParameters),
          current = _this$state$searchPar.current,
          filters = _this$state$searchPar.filters,
          resultsPerPage = _this$state$searchPar.resultsPerPage,
          searchTerm = _this$state$searchPar.searchTerm,
          sortDirection = _this$state$searchPar.sortDirection,
          sortField = _this$state$searchPar.sortField,
          sortList = _this$state$searchPar.sortList; // State updates should always be applied in the order that they are made. This function, _updateSearchResults,
      // makes state updates.
      // In the case where a call to "_updateSearchResults" was made and delayed for X amount of time using
      // `debounceManager.runWithDebounce`, and a subsequent call is made _updateSearchResults before that delay ends, we
      // want to make sure that outstanding call to "_updateSearchResults" is cancelled, as it would apply state updates
      // out of order.


      _this.debounceManager.cancelByName("_updateSearchResults");

      _this._setState({
        current: current,
        error: "",
        filters: filters,
        resultsPerPage: resultsPerPage,
        searchTerm: searchTerm,
        sortDirection: sortDirection,
        sortField: sortField,
        sortList: sortList
      });

      _this._makeSearchRequest({
        skipPushToUrl: skipPushToUrl,
        replaceUrl: replaceUrl
      });
    });

    _defineProperty(this, "_makeSearchRequest", DebounceManager.debounce(0, function (_ref7) {
      var skipPushToUrl = _ref7.skipPushToUrl,
          replaceUrl = _ref7.replaceUrl;
      var _this$state = _this.state,
          current = _this$state.current,
          filters = _this$state.filters,
          resultsPerPage = _this$state.resultsPerPage,
          searchTerm = _this$state.searchTerm,
          sortDirection = _this$state.sortDirection,
          sortField = _this$state.sortField,
          sortList = _this$state.sortList;

      _this._setState({
        isLoading: true
      });

      var requestId = _this.searchRequestSequencer.next();

      var _this$searchQuery = _this.searchQuery,
          searchQueryFilters = _this$searchQuery.filters,
          conditionalFacets = _this$searchQuery.conditionalFacets,
          restOfSearchQuery = _objectWithoutProperties(_this$searchQuery, _excluded);

      var queryConfig = _objectSpread(_objectSpread({}, restOfSearchQuery), {}, {
        facets: removeConditionalFacets(_this.searchQuery.facets, conditionalFacets, filters)
      });

      var requestState = _objectSpread(_objectSpread({}, filterSearchParameters(_this.state)), {}, {
        filters: mergeFilters(filters, _this.searchQuery.filters)
      });

      return _this.events.search(requestState, queryConfig).then(function (resultState) {
        if (_this.searchRequestSequencer.isOldRequest(requestId)) return;

        _this.searchRequestSequencer.completed(requestId); // Results paging start & end


        var totalResults = resultState.totalResults;
        var start = totalResults === 0 ? 0 : (current - 1) * resultsPerPage + 1;
        var end = totalResults <= start + resultsPerPage ? totalResults : start + resultsPerPage - 1;

        _this._setState(_objectSpread(_objectSpread({
          isLoading: false,
          resultSearchTerm: searchTerm,
          pagingStart: start,
          pagingEnd: end
        }, resultState), {}, {
          wasSearched: true
        }));

        if (_this.hasA11yNotifications) {
          var messageArgs = {
            start: start,
            end: end,
            totalResults: totalResults,
            searchTerm: searchTerm
          };

          _this.actions.a11yNotify("searchResults", messageArgs);
        }

        if (!skipPushToUrl && _this.trackUrlState) {
          // We debounce here so that we don't get a lot of intermediary
          // URL state if someone is updating a UI really fast, like typing
          // in a live search box for instance.
          _this.debounceManager.runWithDebounce(_this.urlPushDebounceLength, "pushStateToURL", _this.URLManager.pushStateToURL.bind(_this.URLManager), {
            current: current,
            filters: filters,
            resultsPerPage: resultsPerPage,
            searchTerm: searchTerm,
            sortDirection: sortDirection,
            sortField: sortField,
            sortList: sortList
          }, {
            replaceUrl: replaceUrl
          });
        }
      }, function (error) {
        _this._setState({
          error: "An unexpected error occurred: ".concat(error.message)
        });
      });
    }));

    this.actions = Object.entries(actions).reduce(function (acc, _ref8) {
      var _ref9 = _slicedToArray(_ref8, 2),
          actionName = _ref9[0],
          action = _ref9[1];

      return _objectSpread(_objectSpread({}, acc), {}, _defineProperty({}, actionName, action.bind(_this)));
    }, {});
    Object.assign(this, this.actions);
    this.events = new Events({
      apiConnector: apiConnector,
      onSearch: onSearch,
      onAutocomplete: onAutocomplete,
      onResultClick: onResultClick,
      onAutocompleteResultClick: onAutocompleteResultClick
    });
    this.debug = debug;

    if (this.debug) {
      console.warn("Search UI Debugging is enabled. This should be turned off in production deployments.");
      window.searchUI = this;
    }

    this.autocompleteRequestSequencer = new RequestSequencer();
    this.searchRequestSequencer = new RequestSequencer();
    this.debounceManager = new DebounceManager();
    this.autocompleteQuery = autocompleteQuery;
    this.searchQuery = searchQuery;
    this.subscriptions = [];
    this.trackUrlState = trackUrlState;
    this.urlPushDebounceLength = urlPushDebounceLength;
    this.alwaysSearchOnInitialLoad = alwaysSearchOnInitialLoad;
    var urlState;

    if (trackUrlState) {
      this.URLManager = new URLManager();
      urlState = this.URLManager.getStateFromURL();
      this.URLManager.onURLStateChange(function (urlState) {
        _this._updateSearchResults(_objectSpread(_objectSpread({}, DEFAULT_STATE), urlState), {
          skipPushToUrl: true
        });
      });
    } else {
      urlState = {};
    } // Manage screen reader accessible notifications


    this.hasA11yNotifications = hasA11yNotifications;
    if (this.hasA11yNotifications) a11y.getLiveRegion();
    this.a11yNotificationMessages = _objectSpread(_objectSpread({}, a11y.defaultMessages), a11yNotificationMessages); // Remember the state this application is initialized into, so that we can
    // reset to it later.

    this.startingState = _objectSpread(_objectSpread({}, this.state), initialState); // We filter these here to disallow anything other than valid search
    // parameters to be passed in initial state, or url state. `results`, etc,
    // should not be allowed to be passed in, that should be generated based on
    // the results of the query

    var _searchParameters = filterSearchParameters(_objectSpread(_objectSpread({}, this.startingState), urlState)); // Initialize the state without calling _setState, because we don't
    // want to trigger an update callback, we're just initializing the state
    // to the correct default values for the initial UI render


    this.state = _objectSpread(_objectSpread({}, this.state), _searchParameters); // We'll trigger an initial search if initial parameters contain
    // a search term or filters, or if alwaysSearchOnInitialLoad is set.
    // Otherwise, we'll just save their selections in state as initial values.

    if (_searchParameters.searchTerm || _searchParameters.filters.length > 0 || this.alwaysSearchOnInitialLoad) {
      this._updateSearchResults(_searchParameters, {
        replaceUrl: true
      });
    }
  }
  /**
   * This method is used to update state and trigger a new autocomplete search.
   *
   * @param {string} searchTerm
   * @param {Object=} Object
   * @param {boolean|Object} options.autocompleteResults - Should autocomplete results
   * @param {boolean|Object} options.autocompleteSuggestions - Should autocomplete suggestions
   */


  _createClass(SearchDriver, [{
    key: "_setState",
    value: function _setState(newState) {
      var state = _objectSpread(_objectSpread({}, this.state), newState); // eslint-disable-next-line no-console


      if (this.debug) console.log("Search UI: State Update", newState, state);
      this.state = state;
      this.subscriptions.forEach(function (subscription) {
        return subscription(state);
      });
    }
    /**
     * Dynamically update the searchQuery configuration in this driver.
     * This will issue a new query after being updated.
     *
     * @param Object searchQuery
     */

  }, {
    key: "setSearchQuery",
    value: function setSearchQuery(searchQuery) {
      this.searchQuery = searchQuery;

      this._updateSearchResults();
    }
    /**
     * @param Object autocompleteQuery
     */

  }, {
    key: "setAutocompleteQuery",
    value: function setAutocompleteQuery(autocompleteQuery) {
      this.autocompleteQuery = autocompleteQuery;
    }
    /**
     * Any time state is updated in this Driver, the provided callback
     * will be executed with the updated state.
     *
     * @param onStateChange Function
     */

  }, {
    key: "subscribeToStateChanges",
    value: function subscribeToStateChanges(onStateChange) {
      this.subscriptions.push(onStateChange);
    }
    /**
     * @param onStateChange Function
     */

  }, {
    key: "unsubscribeToStateChanges",
    value: function unsubscribeToStateChanges(onStateChange) {
      this.subscriptions = this.subscriptions.filter(function (sub) {
        return sub !== onStateChange;
      });
    }
    /**
     * Remove all listeners
     */

  }, {
    key: "tearDown",
    value: function tearDown() {
      this.subscriptions = [];
      this.URLManager && this.URLManager.tearDown();
    }
    /**
     * Retrieves all available acitons
     *
     * @returns Object All actions
     */

  }, {
    key: "getActions",
    value: function getActions() {
      return this.actions;
    }
    /**
     * Retrieve current state. Typically used on app initialization. Subsequent
     * state updates should come through subscription.
     *
     * @returns Object Current state
     */

  }, {
    key: "getState",
    value: function getState() {
      // We return a copy of state here, because we want to ensure the state
      // inside of this object remains immutable.
      return _objectSpread({}, this.state);
    }
  }]);

  return SearchDriver;
}();

export { SearchDriver as default };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9TZWFyY2hEcml2ZXIuanMiXSwibmFtZXMiOlsiVVJMTWFuYWdlciIsIlJlcXVlc3RTZXF1ZW5jZXIiLCJEZWJvdW5jZU1hbmFnZXIiLCJhY3Rpb25zIiwiRXZlbnRzIiwibWVyZ2VGaWx0ZXJzIiwiYTExeSIsImZpbHRlclNlYXJjaFBhcmFtZXRlcnMiLCJjdXJyZW50IiwiZmlsdGVycyIsInJlc3VsdHNQZXJQYWdlIiwic2VhcmNoVGVybSIsInNvcnREaXJlY3Rpb24iLCJzb3J0RmllbGQiLCJzb3J0TGlzdCIsIkRFRkFVTFRfU1RBVEUiLCJhdXRvY29tcGxldGVkUmVzdWx0cyIsImF1dG9jb21wbGV0ZWRSZXN1bHRzUmVxdWVzdElkIiwiYXV0b2NvbXBsZXRlZFN1Z2dlc3Rpb25zIiwiYXV0b2NvbXBsZXRlZFN1Z2dlc3Rpb25zUmVxdWVzdElkIiwiZXJyb3IiLCJpc0xvYWRpbmciLCJmYWNldHMiLCJyZXF1ZXN0SWQiLCJyZXN1bHRzIiwicmVzdWx0U2VhcmNoVGVybSIsInRvdGFsUGFnZXMiLCJ0b3RhbFJlc3VsdHMiLCJwYWdpbmdTdGFydCIsInBhZ2luZ0VuZCIsIndhc1NlYXJjaGVkIiwicmF3UmVzcG9uc2UiLCJyZW1vdmVDb25kaXRpb25hbEZhY2V0cyIsImNvbmRpdGlvbmFsRmFjZXRzIiwiT2JqZWN0IiwiZW50cmllcyIsInJlZHVjZSIsImFjYyIsImZhY2V0S2V5IiwiZmFjZXQiLCJTZWFyY2hEcml2ZXIiLCJhcGlDb25uZWN0b3IiLCJhdXRvY29tcGxldGVRdWVyeSIsImRlYnVnIiwiaW5pdGlhbFN0YXRlIiwib25TZWFyY2giLCJvbkF1dG9jb21wbGV0ZSIsIm9uUmVzdWx0Q2xpY2siLCJvbkF1dG9jb21wbGV0ZVJlc3VsdENsaWNrIiwic2VhcmNoUXVlcnkiLCJ0cmFja1VybFN0YXRlIiwidXJsUHVzaERlYm91bmNlTGVuZ3RoIiwiaGFzQTExeU5vdGlmaWNhdGlvbnMiLCJhMTF5Tm90aWZpY2F0aW9uTWVzc2FnZXMiLCJhbHdheXNTZWFyY2hPbkluaXRpYWxMb2FkIiwiYXV0b2NvbXBsZXRlUmVzdWx0cyIsImF1dG9jb21wbGV0ZVN1Z2dlc3Rpb25zIiwiYXV0b2NvbXBsZXRlUmVxdWVzdFNlcXVlbmNlciIsIm5leHQiLCJxdWVyeUNvbmZpZyIsInN1Z2dlc3Rpb25zIiwiZXZlbnRzIiwiYXV0b2NvbXBsZXRlIiwidGhlbiIsImF1dG9jb21wbGV0ZWQiLCJpc09sZFJlcXVlc3QiLCJjb21wbGV0ZWQiLCJfc2V0U3RhdGUiLCJzZWFyY2hQYXJhbWV0ZXJzIiwic2tpcFB1c2hUb1VybCIsInJlcGxhY2VVcmwiLCJzdGF0ZSIsImRlYm91bmNlTWFuYWdlciIsImNhbmNlbEJ5TmFtZSIsIl9tYWtlU2VhcmNoUmVxdWVzdCIsImRlYm91bmNlIiwic2VhcmNoUmVxdWVzdFNlcXVlbmNlciIsInNlYXJjaFF1ZXJ5RmlsdGVycyIsInJlc3RPZlNlYXJjaFF1ZXJ5IiwicmVxdWVzdFN0YXRlIiwic2VhcmNoIiwicmVzdWx0U3RhdGUiLCJzdGFydCIsImVuZCIsIm1lc3NhZ2VBcmdzIiwiYTExeU5vdGlmeSIsInJ1bldpdGhEZWJvdW5jZSIsInB1c2hTdGF0ZVRvVVJMIiwiYmluZCIsIm1lc3NhZ2UiLCJhY3Rpb25OYW1lIiwiYWN0aW9uIiwiYXNzaWduIiwiY29uc29sZSIsIndhcm4iLCJ3aW5kb3ciLCJzZWFyY2hVSSIsInN1YnNjcmlwdGlvbnMiLCJ1cmxTdGF0ZSIsImdldFN0YXRlRnJvbVVSTCIsIm9uVVJMU3RhdGVDaGFuZ2UiLCJfdXBkYXRlU2VhcmNoUmVzdWx0cyIsImdldExpdmVSZWdpb24iLCJkZWZhdWx0TWVzc2FnZXMiLCJzdGFydGluZ1N0YXRlIiwibGVuZ3RoIiwibmV3U3RhdGUiLCJsb2ciLCJmb3JFYWNoIiwic3Vic2NyaXB0aW9uIiwib25TdGF0ZUNoYW5nZSIsInB1c2giLCJmaWx0ZXIiLCJzdWIiLCJ0ZWFyRG93biJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQSxPQUFPQSxVQUFQLE1BQXVCLGNBQXZC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LE1BQW5CLENBQ25CLFVBQUFDLEdBQUc7QUFBQSxlQUFJQSxHQUFHLEtBQUtILGFBQVo7QUFBQSxPQURnQixDQUFyQjtBQUdEO0FBRUQ7QUFDRjtBQUNBOzs7O1dBQ0Usb0JBQVc7QUFDVCxXQUFLYixhQUFMLEdBQXFCLEVBQXJCO0FBQ0EsV0FBS2pHLFVBQUwsSUFBbUIsS0FBS0EsVUFBTCxDQUFnQmtILFFBQWhCLEVBQW5CO0FBQ0Q7QUFFRDtBQUNGO0FBQ0E7QUFDQTtBQUNBOzs7O1dBQ0Usc0JBQWE7QUFDWCxhQUFPLEtBQUsvRyxPQUFaO0FBQ0Q7QUFFRDtBQUNGO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7Ozs7V0FDRSxvQkFBVztBQUNUO0FBQ0E7QUFDQSwrQkFBWSxLQUFLb0UsS0FBakI7QUFDRDs7Ozs7O1NBalprQi9CLFkiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgVVJMTWFuYWdlciBmcm9tIFwiLi9VUkxNYW5hZ2VyXCI7XG5cbmltcG9ydCBSZXF1ZXN0U2VxdWVuY2VyIGZyb20gXCIuL1JlcXVlc3RTZXF1ZW5jZXJcIjtcbmltcG9ydCBEZWJvdW5jZU1hbmFnZXIgZnJvbSBcIi4vRGVib3VuY2VNYW5hZ2VyXCI7XG5cbmltcG9ydCAqIGFzIGFjdGlvbnMgZnJvbSBcIi4vYWN0aW9uc1wiO1xuaW1wb3J0IEV2ZW50cyBmcm9tIFwiLi9FdmVudHNcIjtcbmltcG9ydCB7IG1lcmdlRmlsdGVycyB9IGZyb20gXCIuL2hlbHBlcnNcIjtcblxuaW1wb3J0ICogYXMgYTExeSBmcm9tIFwiLi9BMTF5Tm90aWZpY2F0aW9uc1wiO1xuXG5mdW5jdGlvbiBmaWx0ZXJTZWFyY2hQYXJhbWV0ZXJzKHtcbiAgY3VycmVudCxcbiAgZmlsdGVycyxcbiAgcmVzdWx0c1BlclBhZ2UsXG4gIHNlYXJjaFRlcm0sXG4gIHNvcnREaXJlY3Rpb24sXG4gIHNvcnRGaWVsZCxcbiAgc29ydExpc3Rcbn0pIHtcbiAgcmV0dXJuIHtcbiAgICBjdXJyZW50LFxuICAgIGZpbHRlcnMsXG4gICAgcmVzdWx0c1BlclBhZ2UsXG4gICAgc2VhcmNoVGVybSxcbiAgICBzb3J0RGlyZWN0aW9uLFxuICAgIHNvcnRGaWVsZCxcbiAgICBzb3J0TGlzdFxuICB9O1xufVxuXG5leHBvcnQgY29uc3QgREVGQVVMVF9TVEFURSA9IHtcbiAgLy8gU2VhcmNoIFBhcmFtZXRlcnMgLS0gVGhpcyBpcyBzdGF0ZSB0aGF0IHJlcHJlc2VudHMgdGhlIGlucHV0IHN0YXRlLlxuICBjdXJyZW50OiAxLFxuICBmaWx0ZXJzOiBbXSxcbiAgcmVzdWx0c1BlclBhZ2U6IDIwLFxuICBzZWFyY2hUZXJtOiBcIlwiLFxuICBzb3J0RGlyZWN0aW9uOiBcIlwiLFxuICBzb3J0RmllbGQ6IFwiXCIsXG4gIHNvcnRMaXN0OiBbXSxcbiAgLy8gUmVzdWx0IFN0YXRlIC0tIFRoaXMgc3RhdGUgcmVwcmVzZW50cyBzdGF0ZSB0aGF0IGlzIHVwZGF0ZWQgYXV0b21hdGljYWxseVxuICAvLyBhcyB0aGUgcmVzdWx0IG9mIGNoYW5naW5nIGlucHV0IHN0YXRlLlxuICBhdXRvY29tcGxldGVkUmVzdWx0czogW10sXG4gIGF1dG9jb21wbGV0ZWRSZXN1bHRzUmVxdWVzdElkOiBcIlwiLFxuICBhdXRvY29tcGxldGVkU3VnZ2VzdGlvbnM6IHt9LFxuICBhdXRvY29tcGxldGVkU3VnZ2VzdGlvbnNSZXF1ZXN0SWQ6IFwiXCIsXG4gIGVycm9yOiBcIlwiLFxuICBpc0xvYWRpbmc6IGZhbHNlLFxuICBmYWNldHM6IHt9LFxuICByZXF1ZXN0SWQ6IFwiXCIsXG4gIHJlc3VsdHM6IFtdLFxuICByZXN1bHRTZWFyY2hUZXJtOiBcIlwiLFxuICB0b3RhbFBhZ2VzOiAwLFxuICB0b3RhbFJlc3VsdHM6IDAsXG4gIHBhZ2luZ1N0YXJ0OiAwLFxuICBwYWdpbmdFbmQ6IDAsXG4gIHdhc1NlYXJjaGVkOiBmYWxzZSxcbiAgcmF3UmVzcG9uc2U6IHt9XG59O1xuXG5mdW5jdGlvbiByZW1vdmVDb25kaXRpb25hbEZhY2V0cyhcbiAgZmFjZXRzID0ge30sXG4gIGNvbmRpdGlvbmFsRmFjZXRzID0ge30sXG4gIGZpbHRlcnMgPSBbXVxuKSB7XG4gIHJldHVybiBPYmplY3QuZW50cmllcyhmYWNldHMpLnJlZHVjZSgoYWNjLCBbZmFjZXRLZXksIGZhY2V0XSkgPT4ge1xuICAgIGlmIChcbiAgICAgIGNvbmRpdGlvbmFsRmFjZXRzW2ZhY2V0S2V5XSAmJlxuICAgICAgdHlwZW9mIGNvbmRpdGlvbmFsRmFjZXRzW2ZhY2V0S2V5XSA9PT0gXCJmdW5jdGlvblwiICYmXG4gICAgICAhY29uZGl0aW9uYWxGYWNldHNbZmFjZXRLZXldKHsgZmlsdGVycyB9KVxuICAgICkge1xuICAgICAgcmV0dXJuIGFjYztcbiAgICB9XG5cbiAgICBhY2NbZmFjZXRLZXldID0gZmFjZXQ7XG4gICAgcmV0dXJuIGFjYztcbiAgfSwge30pO1xufVxuXG4vKlxuICogVGhlIERyaXZlciBpcyBhIGZyYW1ld29yayBhZ25vc3RpYyBzZWFyY2ggc3RhdGUgbWFuYWdlciB0aGF0IGlzIGNhcGFibGVcbiAqIHN5bmNpbmcgc3RhdGUgdG8gdGhlIHVybC5cbiAqL1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgU2VhcmNoRHJpdmVyIHtcbiAgc3RhdGUgPSBERUZBVUxUX1NUQVRFO1xuXG4gIGNvbnN0cnVjdG9yKHtcbiAgICBhcGlDb25uZWN0b3IsXG4gICAgYXV0b2NvbXBsZXRlUXVlcnkgPSB7fSxcbiAgICBkZWJ1ZyxcbiAgICBpbml0aWFsU3RhdGUsXG4gICAgb25TZWFyY2gsXG4gICAgb25BdXRvY29tcGxldGUsXG4gICAgb25SZXN1bHRDbGljayxcbiAgICBvbkF1dG9jb21wbGV0ZVJlc3VsdENsaWNrLFxuICAgIHNlYXJjaFF1ZXJ5ID0ge30sXG4gICAgdHJhY2tVcmxTdGF0ZSA9IHRydWUsXG4gICAgdXJsUHVzaERlYm91bmNlTGVuZ3RoID0gNTAwLFxuICAgIGhhc0ExMXlOb3RpZmljYXRpb25zID0gZmFsc2UsXG4gICAgYTExeU5vdGlmaWNhdGlvbk1lc3NhZ2VzID0ge30sXG4gICAgYWx3YXlzU2VhcmNoT25Jbml0aWFsTG9hZCA9IGZhbHNlXG4gIH0pIHtcbiAgICB0aGlzLmFjdGlvbnMgPSBPYmplY3QuZW50cmllcyhhY3Rpb25zKS5yZWR1Y2UoXG4gICAgICAoYWNjLCBbYWN0aW9uTmFtZSwgYWN0aW9uXSkgPT4ge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIC4uLmFjYyxcbiAgICAgICAgICBbYWN0aW9uTmFtZV06IGFjdGlvbi5iaW5kKHRoaXMpXG4gICAgICAgIH07XG4gICAgICB9LFxuICAgICAge31cbiAgICApO1xuICAgIE9iamVjdC5hc3NpZ24odGhpcywgdGhpcy5hY3Rpb25zKTtcblxuICAgIHRoaXMuZXZlbnRzID0gbmV3IEV2ZW50cyh7XG4gICAgICBhcGlDb25uZWN0b3IsXG4gICAgICBvblNlYXJjaCxcbiAgICAgIG9uQXV0b2NvbXBsZXRlLFxuICAgICAgb25SZXN1bHRDbGljayxcbiAgICAgIG9uQXV0b2NvbXBsZXRlUmVzdWx0Q2xpY2tcbiAgICB9KTtcblxuICAgIHRoaXMuZGVidWcgPSBkZWJ1ZztcbiAgICBpZiAodGhpcy5kZWJ1Zykge1xuICAgICAgY29uc29sZS53YXJuKFxuICAgICAgICBcIlNlYXJjaCBVSSBEZWJ1Z2dpbmcgaXMgZW5hYmxlZC4gVGhpcyBzaG91bGQgYmUgdHVybmVkIG9mZiBpbiBwcm9kdWN0aW9uIGRlcGxveW1lbnRzLlwiXG4gICAgICApO1xuICAgICAgd2luZG93LnNlYXJjaFVJID0gdGhpcztcbiAgICB9XG4gICAgdGhpcy5hdXRvY29tcGxldGVSZXF1ZXN0U2VxdWVuY2VyID0gbmV3IFJlcXVlc3RTZXF1ZW5jZXIoKTtcbiAgICB0aGlzLnNlYXJjaFJlcXVlc3RTZXF1ZW5jZXIgPSBuZXcgUmVxdWVzdFNlcXVlbmNlcigpO1xuICAgIHRoaXMuZGVib3VuY2VNYW5hZ2VyID0gbmV3IERlYm91bmNlTWFuYWdlcigpO1xuICAgIHRoaXMuYXV0b2NvbXBsZXRlUXVlcnkgPSBhdXRvY29tcGxldGVRdWVyeTtcbiAgICB0aGlzLnNlYXJjaFF1ZXJ5ID0gc2VhcmNoUXVlcnk7XG4gICAgdGhpcy5zdWJzY3JpcHRpb25zID0gW107XG4gICAgdGhpcy50cmFja1VybFN0YXRlID0gdHJhY2tVcmxTdGF0ZTtcbiAgICB0aGlzLnVybFB1c2hEZWJvdW5jZUxlbmd0aCA9IHVybFB1c2hEZWJvdW5jZUxlbmd0aDtcbiAgICB0aGlzLmFsd2F5c1NlYXJjaE9uSW5pdGlhbExvYWQgPSBhbHdheXNTZWFyY2hPbkluaXRpYWxMb2FkO1xuXG4gICAgbGV0IHVybFN0YXRlO1xuICAgIGlmICh0cmFja1VybFN0YXRlKSB7XG4gICAgICB0aGlzLlVSTE1hbmFnZXIgPSBuZXcgVVJMTWFuYWdlcigpO1xuICAgICAgdXJsU3RhdGUgPSB0aGlzLlVSTE1hbmFnZXIuZ2V0U3RhdGVGcm9tVVJMKCk7XG4gICAgICB0aGlzLlVSTE1hbmFnZXIub25VUkxTdGF0ZUNoYW5nZSh1cmxTdGF0ZSA9PiB7XG4gICAgICAgIHRoaXMuX3VwZGF0ZVNlYXJjaFJlc3VsdHMoXG4gICAgICAgICAgeyAuLi5ERUZBVUxUX1NUQVRFLCAuLi51cmxTdGF0ZSB9LFxuICAgICAgICAgIHsgc2tpcFB1c2hUb1VybDogdHJ1ZSB9XG4gICAgICAgICk7XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdXJsU3RhdGUgPSB7fTtcbiAgICB9XG5cbiAgICAvLyBNYW5hZ2Ugc2NyZWVuIHJlYWRlciBhY2Nlc3NpYmxlIG5vdGlmaWNhdGlvbnNcbiAgICB0aGlzLmhhc0ExMXlOb3RpZmljYXRpb25zID0gaGFzQTExeU5vdGlmaWNhdGlvbnM7XG4gICAgaWYgKHRoaXMuaGFzQTExeU5vdGlmaWNhdGlvbnMpIGExMXkuZ2V0TGl2ZVJlZ2lvbigpO1xuXG4gICAgdGhpcy5hMTF5Tm90aWZpY2F0aW9uTWVzc2FnZXMgPSB7XG4gICAgICAuLi5hMTF5LmRlZmF1bHRNZXNzYWdlcyxcbiAgICAgIC4uLmExMXlOb3RpZmljYXRpb25NZXNzYWdlc1xuICAgIH07XG5cbiAgICAvLyBSZW1lbWJlciB0aGUgc3RhdGUgdGhpcyBhcHBsaWNhdGlvbiBpcyBpbml0aWFsaXplZCBpbnRvLCBzbyB0aGF0IHdlIGNhblxuICAgIC8vIHJlc2V0IHRvIGl0IGxhdGVyLlxuICAgIHRoaXMuc3RhcnRpbmdTdGF0ZSA9IHtcbiAgICAgIC4uLnRoaXMuc3RhdGUsXG4gICAgICAuLi5pbml0aWFsU3RhdGVcbiAgICB9O1xuXG4gICAgLy8gV2UgZmlsdGVyIHRoZXNlIGhlcmUgdG8gZGlzYWxsb3cgYW55dGhpbmcgb3RoZXIgdGhhbiB2YWxpZCBzZWFyY2hcbiAgICAvLyBwYXJhbWV0ZXJzIHRvIGJlIHBhc3NlZCBpbiBpbml0aWFsIHN0YXRlLCBvciB1cmwgc3RhdGUuIGByZXN1bHRzYCwgZXRjLFxuICAgIC8vIHNob3VsZCBub3QgYmUgYWxsb3dlZCB0byBiZSBwYXNzZWQgaW4sIHRoYXQgc2hvdWxkIGJlIGdlbmVyYXRlZCBiYXNlZCBvblxuICAgIC8vIHRoZSByZXN1bHRzIG9mIHRoZSBxdWVyeVxuICAgIGNvbnN0IHNlYXJjaFBhcmFtZXRlcnMgPSBmaWx0ZXJTZWFyY2hQYXJhbWV0ZXJzKHtcbiAgICAgIC4uLnRoaXMuc3RhcnRpbmdTdGF0ZSxcbiAgICAgIC4uLnVybFN0YXRlXG4gICAgfSk7XG5cbiAgICAvLyBJbml0aWFsaXplIHRoZSBzdGF0ZSB3aXRob3V0IGNhbGxpbmcgX3NldFN0YXRlLCBiZWNhdXNlIHdlIGRvbid0XG4gICAgLy8gd2FudCB0byB0cmlnZ2VyIGFuIHVwZGF0ZSBjYWxsYmFjaywgd2UncmUganVzdCBpbml0aWFsaXppbmcgdGhlIHN0YXRlXG4gICAgLy8gdG8gdGhlIGNvcnJlY3QgZGVmYXVsdCB2YWx1ZXMgZm9yIHRoZSBpbml0aWFsIFVJIHJlbmRlclxuICAgIHRoaXMuc3RhdGUgPSB7XG4gICAgICAuLi50aGlzLnN0YXRlLFxuICAgICAgLi4uc2VhcmNoUGFyYW1ldGVyc1xuICAgIH07XG5cbiAgICAvLyBXZSdsbCB0cmlnZ2VyIGFuIGluaXRpYWwgc2VhcmNoIGlmIGluaXRpYWwgcGFyYW1ldGVycyBjb250YWluXG4gICAgLy8gYSBzZWFyY2ggdGVybSBvciBmaWx0ZXJzLCBvciBpZiBhbHdheXNTZWFyY2hPbkluaXRpYWxMb2FkIGlzIHNldC5cbiAgICAvLyBPdGhlcndpc2UsIHdlJ2xsIGp1c3Qgc2F2ZSB0aGVpciBzZWxlY3Rpb25zIGluIHN0YXRlIGFzIGluaXRpYWwgdmFsdWVzLlxuICAgIGlmIChcbiAgICAgIHNlYXJjaFBhcmFtZXRlcnMuc2VhcmNoVGVybSB8fFxuICAgICAgc2VhcmNoUGFyYW1ldGVycy5maWx0ZXJzLmxlbmd0aCA+IDAgfHxcbiAgICAgIHRoaXMuYWx3YXlzU2VhcmNoT25Jbml0aWFsTG9hZFxuICAgICkge1xuICAgICAgdGhpcy5fdXBkYXRlU2VhcmNoUmVzdWx0cyhzZWFyY2hQYXJhbWV0ZXJzLCB7IHJlcGxhY2VVcmw6IHRydWUgfSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFRoaXMgbWV0aG9kIGlzIHVzZWQgdG8gdXBkYXRlIHN0YXRlIGFuZCB0cmlnZ2VyIGEgbmV3IGF1dG9jb21wbGV0ZSBzZWFyY2guXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBzZWFyY2hUZXJtXG4gICAqIEBwYXJhbSB7T2JqZWN0PX0gT2JqZWN0XG4gICAqIEBwYXJhbSB7Ym9vbGVhbnxPYmplY3R9IG9wdGlvbnMuYXV0b2NvbXBsZXRlUmVzdWx0cyAtIFNob3VsZCBhdXRvY29tcGxldGUgcmVzdWx0c1xuICAgKiBAcGFyYW0ge2Jvb2xlYW58T2JqZWN0fSBvcHRpb25zLmF1dG9jb21wbGV0ZVN1Z2dlc3Rpb25zIC0gU2hvdWxkIGF1dG9jb21wbGV0ZSBzdWdnZXN0aW9uc1xuICAgKi9cbiAgX3VwZGF0ZUF1dG9jb21wbGV0ZSA9IChcbiAgICBzZWFyY2hUZXJtLFxuICAgIHsgYXV0b2NvbXBsZXRlUmVzdWx0cywgYXV0b2NvbXBsZXRlU3VnZ2VzdGlvbnMgfSA9IHt9XG4gICkgPT4ge1xuICAgIGNvbnN0IHJlcXVlc3RJZCA9IHRoaXMuYXV0b2NvbXBsZXRlUmVxdWVzdFNlcXVlbmNlci5uZXh0KCk7XG5cbiAgICBjb25zdCBxdWVyeUNvbmZpZyA9IHtcbiAgICAgIC4uLihhdXRvY29tcGxldGVSZXN1bHRzICYmIHtcbiAgICAgICAgcmVzdWx0czogdGhpcy5hdXRvY29tcGxldGVRdWVyeS5yZXN1bHRzIHx8IHt9XG4gICAgICB9KSxcbiAgICAgIC4uLihhdXRvY29tcGxldGVTdWdnZXN0aW9ucyAmJiB7XG4gICAgICAgIHN1Z2dlc3Rpb25zOiB0aGlzLmF1dG9jb21wbGV0ZVF1ZXJ5LnN1Z2dlc3Rpb25zIHx8IHt9XG4gICAgICB9KVxuICAgIH07XG5cbiAgICByZXR1cm4gdGhpcy5ldmVudHNcbiAgICAgIC5hdXRvY29tcGxldGUoeyBzZWFyY2hUZXJtIH0sIHF1ZXJ5Q29uZmlnKVxuICAgICAgLnRoZW4oYXV0b2NvbXBsZXRlZCA9PiB7XG4gICAgICAgIGlmICh0aGlzLmF1dG9jb21wbGV0ZVJlcXVlc3RTZXF1ZW5jZXIuaXNPbGRSZXF1ZXN0KHJlcXVlc3RJZCkpIHJldHVybjtcbiAgICAgICAgdGhpcy5hdXRvY29tcGxldGVSZXF1ZXN0U2VxdWVuY2VyLmNvbXBsZXRlZChyZXF1ZXN0SWQpO1xuXG4gICAgICAgIHRoaXMuX3NldFN0YXRlKGF1dG9jb21wbGV0ZWQpO1xuICAgICAgfSk7XG4gIH07XG5cbiAgLyoqXG4gICAqIFRoaXMgbWV0aG9kIGlzIHVzZWQgdG8gdXBkYXRlIHN0YXRlIGFuZCB0cmlnZ2VyIGEgbmV3IHNlYXJjaC5cbiAgICpcbiAgICogQHR5cGVkZWYge09iamVjdH0gUmVxdWVzdFN0YXRlXG4gICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBjdXJyZW50XG4gICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSByZXN1bHRzUGVyUGFnZVxuICAgKiBAcHJvcGVydHkge3N0cmluZ30gc2VhcmNoVGVybVxuICAgKiBAcHJvcGVydHkge3N0cmluZ30gc29ydERpcmVjdGlvblxuICAgKiBAcHJvcGVydHkge3N0cmluZ30gc29ydEZpZWxkXG4gICAqIEBwcm9wZXJ0eSB7QXJyYXl9IHNvcnRMaXN0XG4gICAqXG4gICAqIEBwYXJhbSB7UmVxdWVzdFN0YXRlfSBzZWFyY2hQYXJhbWV0ZXJzIC0gUmVxdWVzdFN0YXRlXG4gICAqIEBwYXJhbSB7T2JqZWN0PX0gT2JqZWN0XG4gICAqIEBwYXJhbSB7Ym9vbGVhbn0gb3B0aW9ucy5za2lwUHVzaFRvVXJsIC0gU2tpcCBwdXNoaW5nIHRoZSB1cGRhdGVkIHRvIHRoZSBVUkxcbiAgICogQHBhcmFtIHtib29sZWFufSBvcHRpb25zLnJlcGxhY2VVcmwgLSBXaGVuIHB1c2hpbmcgc3RhdGUgdG8gdGhlIFVSTCwgdXNlIGhpc3RvcnkgJ3JlcGxhY2UnXG4gICAqIHJhdGhlciB0aGFuICdwdXNoJyB0byBhdm9pZCBhZGRpbmcgYSBuZXcgaGlzdG9yeSBlbnRyeVxuICAgKi9cbiAgX3VwZGF0ZVNlYXJjaFJlc3VsdHMgPSAoXG4gICAgc2VhcmNoUGFyYW1ldGVycyxcbiAgICB7IHNraXBQdXNoVG9VcmwgPSBmYWxzZSwgcmVwbGFjZVVybCA9IGZhbHNlIH0gPSB7fVxuICApID0+IHtcbiAgICBjb25zdCB7XG4gICAgICBjdXJyZW50LFxuICAgICAgZmlsdGVycyxcbiAgICAgIHJlc3VsdHNQZXJQYWdlLFxuICAgICAgc2VhcmNoVGVybSxcbiAgICAgIHNvcnREaXJlY3Rpb24sXG4gICAgICBzb3J0RmllbGQsXG4gICAgICBzb3J0TGlzdFxuICAgIH0gPSB7XG4gICAgICAuLi50aGlzLnN0YXRlLFxuICAgICAgLi4uc2VhcmNoUGFyYW1ldGVyc1xuICAgIH07XG5cbiAgICAvLyBTdGF0ZSB1cGRhdGVzIHNob3VsZCBhbHdheXMgYmUgYXBwbGllZCBpbiB0aGUgb3JkZXIgdGhhdCB0aGV5IGFyZSBtYWRlLiBUaGlzIGZ1bmN0aW9uLCBfdXBkYXRlU2VhcmNoUmVzdWx0cyxcbiAgICAvLyBtYWtlcyBzdGF0ZSB1cGRhdGVzLlxuICAgIC8vIEluIHRoZSBjYXNlIHdoZXJlIGEgY2FsbCB0byBcIl91cGRhdGVTZWFyY2hSZXN1bHRzXCIgd2FzIG1hZGUgYW5kIGRlbGF5ZWQgZm9yIFggYW1vdW50IG9mIHRpbWUgdXNpbmdcbiAgICAvLyBgZGVib3VuY2VNYW5hZ2VyLnJ1bldpdGhEZWJvdW5jZWAsIGFuZCBhIHN1YnNlcXVlbnQgY2FsbCBpcyBtYWRlIF91cGRhdGVTZWFyY2hSZXN1bHRzIGJlZm9yZSB0aGF0IGRlbGF5IGVuZHMsIHdlXG4gICAgLy8gd2FudCB0byBtYWtlIHN1cmUgdGhhdCBvdXRzdGFuZGluZyBjYWxsIHRvIFwiX3VwZGF0ZVNlYXJjaFJlc3VsdHNcIiBpcyBjYW5jZWxsZWQsIGFzIGl0IHdvdWxkIGFwcGx5IHN0YXRlIHVwZGF0ZXNcbiAgICAvLyBvdXQgb2Ygb3JkZXIuXG4gICAgdGhpcy5kZWJvdW5jZU1hbmFnZXIuY2FuY2VsQnlOYW1lKFwiX3VwZGF0ZVNlYXJjaFJlc3VsdHNcIik7XG5cbiAgICB0aGlzLl9zZXRTdGF0ZSh7XG4gICAgICBjdXJyZW50LFxuICAgICAgZXJyb3I6IFwiXCIsXG4gICAgICBmaWx0ZXJzLFxuICAgICAgcmVzdWx0c1BlclBhZ2UsXG4gICAgICBzZWFyY2hUZXJtLFxuICAgICAgc29ydERpcmVjdGlvbixcbiAgICAgIHNvcnRGaWVsZCxcbiAgICAgIHNvcnRMaXN0XG4gICAgfSk7XG5cbiAgICB0aGlzLl9tYWtlU2VhcmNoUmVxdWVzdCh7XG4gICAgICBza2lwUHVzaFRvVXJsLFxuICAgICAgcmVwbGFjZVVybFxuICAgIH0pO1xuICB9O1xuXG4gIC8qKlxuICAgKiBUaGlzIG1ldGhvZCBpcyBzZXBhcmF0ZWQgb3V0IGZyb20gX3VwZGF0ZVNlYXJjaFJlc3VsdHMgc28gdGhhdCBpdFxuICAgKiBjYW4gYmUgZGVib3VuY2VkLlxuICAgKlxuICAgKiBCeSBkZWJvdW5jaW5nIG91ciBBUEkgY2FsbHMsIHdlIGNhbiBlZmZlY3RpdmVseSBhbGxvdyBhY3Rpb24gY2hhaW5pbmcuXG4gICAqXG4gICAqIEZvciBFeDpcbiAgICpcbiAgICogSWYgYSB1c2VyIG5lZWRzIHRvIG1ha2UgbXVsdGlwbGUgZmlsdGVyIHVwZGF0ZXMgYXQgb25jZSwgdGhleSBjb3VsZFxuICAgKiBkbyBzbyBieSBjYWxsaW5nIGFuIGFjdGlvbiAzIHRpbWVzIGluIGEgcm93OlxuICAgKlxuICAgKiAgIGFkZEZpbHRlcihcInN0YXRlc1wiLCBcIkNhbGlmb3JuaWFcIik7XG4gICAqICAgYWRkRmlsdGVyKFwic3RhdGVzXCIsIFwiTmVicmFza2FcIik7XG4gICAqICAgYWRkRmlsdGVyKFwic3RhdGVzXCIsIFwiUGVubnN5bHZhbmlhXCIpO1xuICAgKlxuICAgKiBXZSBkb24ndCB3YW50IHRvIG1ha2UgMyBzZXBhcmF0ZSBBUEkgY2FsbHMgbGlrZSB0aGF0IGluIHF1aWNrIHN1Y2Nlc3Npb24sXG4gICAqIHNvIHdlIGRlYm91bmNlIHRoZSBBUEkgY2FsbHMuXG4gICAqXG4gICAqIEFwcGxpY2F0aW9uIHN0YXRlIHVwZGF0ZXMgYXJlIHBlcmZvcm1lZCBpbiBfdXBkYXRlU2VhcmNoUmVzdWx0cywgYnV0IHdlXG4gICAqIHdhaXQgdG8gbWFrZSB0aGUgYWN0dWFsIEFQSSBjYWxscyB1bnRpbCBhbGwgYWN0aW9ucyBoYXZlIGJlZW4gY2FsbGVkLlxuICAgKlxuICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9uc1xuICAgKiBAcGFyYW0ge2Jvb2xlYW59IG9wdGlvbnMuc2tpcFB1c2hUb1VybCAtIFNraXAgcHVzaGluZyB0aGUgdXBkYXRlZCB0byB0aGUgVVJMXG4gICAqIEBwYXJhbSB7Ym9vbGVhbn0gb3B0aW9ucy5yZXBsYWNlVXJsIC0gV2hlbiBwdXNoaW5nIHN0YXRlIHRvIHRoZSBVUkwsIHVzZSBoaXN0b3J5ICdyZXBsYWNlJ1xuICAgKiByYXRoZXIgdGhhbiAncHVzaCcgdG8gYXZvaWQgYWRkaW5nIGEgbmV3IGhpc3RvcnkgZW50cnlcbiAgICovXG4gIF9tYWtlU2VhcmNoUmVxdWVzdCA9IERlYm91bmNlTWFuYWdlci5kZWJvdW5jZShcbiAgICAwLFxuICAgICh7IHNraXBQdXNoVG9VcmwsIHJlcGxhY2VVcmwgfSkgPT4ge1xuICAgICAgY29uc3Qge1xuICAgICAgICBjdXJyZW50LFxuICAgICAgICBmaWx0ZXJzLFxuICAgICAgICByZXN1bHRzUGVyUGFnZSxcbiAgICAgICAgc2VhcmNoVGVybSxcbiAgICAgICAgc29ydERpcmVjdGlvbixcbiAgICAgICAgc29ydEZpZWxkLFxuICAgICAgICBzb3J0TGlzdFxuICAgICAgfSA9IHRoaXMuc3RhdGU7XG5cbiAgICAgIHRoaXMuX3NldFN0YXRlKHtcbiAgICAgICAgaXNMb2FkaW5nOiB0cnVlXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgcmVxdWVzdElkID0gdGhpcy5zZWFyY2hSZXF1ZXN0U2VxdWVuY2VyLm5leHQoKTtcblxuICAgICAgY29uc3Qge1xuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdW51c2VkLXZhcnNcbiAgICAgICAgZmlsdGVyczogc2VhcmNoUXVlcnlGaWx0ZXJzLFxuICAgICAgICBjb25kaXRpb25hbEZhY2V0czogY29uZGl0aW9uYWxGYWNldHMsXG4gICAgICAgIC4uLnJlc3RPZlNlYXJjaFF1ZXJ5XG4gICAgICB9ID0gdGhpcy5zZWFyY2hRdWVyeTtcblxuICAgICAgY29uc3QgcXVlcnlDb25maWcgPSB7XG4gICAgICAgIC4uLnJlc3RPZlNlYXJjaFF1ZXJ5LFxuICAgICAgICBmYWNldHM6IHJlbW92ZUNvbmRpdGlvbmFsRmFjZXRzKFxuICAgICAgICAgIHRoaXMuc2VhcmNoUXVlcnkuZmFjZXRzLFxuICAgICAgICAgIGNvbmRpdGlvbmFsRmFjZXRzLFxuICAgICAgICAgIGZpbHRlcnNcbiAgICAgICAgKVxuICAgICAgfTtcbiAgICAgIGNvbnN0IHJlcXVlc3RTdGF0ZSA9IHtcbiAgICAgICAgLi4uZmlsdGVyU2VhcmNoUGFyYW1ldGVycyh0aGlzLnN0YXRlKSxcbiAgICAgICAgZmlsdGVyczogbWVyZ2VGaWx0ZXJzKGZpbHRlcnMsIHRoaXMuc2VhcmNoUXVlcnkuZmlsdGVycylcbiAgICAgIH07XG5cbiAgICAgIHJldHVybiB0aGlzLmV2ZW50cy5zZWFyY2gocmVxdWVzdFN0YXRlLCBxdWVyeUNvbmZpZykudGhlbihcbiAgICAgICAgcmVzdWx0U3RhdGUgPT4ge1xuICAgICAgICAgIGlmICh0aGlzLnNlYXJjaFJlcXVlc3RTZXF1ZW5jZXIuaXNPbGRSZXF1ZXN0KHJlcXVlc3RJZCkpIHJldHVybjtcbiAgICAgICAgICB0aGlzLnNlYXJjaFJlcXVlc3RTZXF1ZW5jZXIuY29tcGxldGVkKHJlcXVlc3RJZCk7XG5cbiAgICAgICAgICAvLyBSZXN1bHRzIHBhZ2luZyBzdGFydCAmIGVuZFxuICAgICAgICAgIGNvbnN0IHsgdG90YWxSZXN1bHRzIH0gPSByZXN1bHRTdGF0ZTtcbiAgICAgICAgICBjb25zdCBzdGFydCA9XG4gICAgICAgICAgICB0b3RhbFJlc3VsdHMgPT09IDAgPyAwIDogKGN1cnJlbnQgLSAxKSAqIHJlc3VsdHNQZXJQYWdlICsgMTtcbiAgICAgICAgICBjb25zdCBlbmQgPVxuICAgICAgICAgICAgdG90YWxSZXN1bHRzIDw9IHN0YXJ0ICsgcmVzdWx0c1BlclBhZ2VcbiAgICAgICAgICAgICAgPyB0b3RhbFJlc3VsdHNcbiAgICAgICAgICAgICAgOiBzdGFydCArIHJlc3VsdHNQZXJQYWdlIC0gMTtcblxuICAgICAgICAgIHRoaXMuX3NldFN0YXRlKHtcbiAgICAgICAgICAgIGlzTG9hZGluZzogZmFsc2UsXG4gICAgICAgICAgICByZXN1bHRTZWFyY2hUZXJtOiBzZWFyY2hUZXJtLFxuICAgICAgICAgICAgcGFnaW5nU3RhcnQ6IHN0YXJ0LFxuICAgICAgICAgICAgcGFnaW5nRW5kOiBlbmQsXG4gICAgICAgICAgICAuLi5yZXN1bHRTdGF0ZSxcbiAgICAgICAgICAgIHdhc1NlYXJjaGVkOiB0cnVlXG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgICBpZiAodGhpcy5oYXNBMTF5Tm90aWZpY2F0aW9ucykge1xuICAgICAgICAgICAgY29uc3QgbWVzc2FnZUFyZ3MgPSB7IHN0YXJ0LCBlbmQsIHRvdGFsUmVzdWx0cywgc2VhcmNoVGVybSB9O1xuICAgICAgICAgICAgdGhpcy5hY3Rpb25zLmExMXlOb3RpZnkoXCJzZWFyY2hSZXN1bHRzXCIsIG1lc3NhZ2VBcmdzKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBpZiAoIXNraXBQdXNoVG9VcmwgJiYgdGhpcy50cmFja1VybFN0YXRlKSB7XG4gICAgICAgICAgICAvLyBXZSBkZWJvdW5jZSBoZXJlIHNvIHRoYXQgd2UgZG9uJ3QgZ2V0IGEgbG90IG9mIGludGVybWVkaWFyeVxuICAgICAgICAgICAgLy8gVVJMIHN0YXRlIGlmIHNvbWVvbmUgaXMgdXBkYXRpbmcgYSBVSSByZWFsbHkgZmFzdCwgbGlrZSB0eXBpbmdcbiAgICAgICAgICAgIC8vIGluIGEgbGl2ZSBzZWFyY2ggYm94IGZvciBpbnN0YW5jZS5cbiAgICAgICAgICAgIHRoaXMuZGVib3VuY2VNYW5hZ2VyLnJ1bldpdGhEZWJvdW5jZShcbiAgICAgICAgICAgICAgdGhpcy51cmxQdXNoRGVib3VuY2VMZW5ndGgsXG4gICAgICAgICAgICAgIFwicHVzaFN0YXRlVG9VUkxcIixcbiAgICAgICAgICAgICAgdGhpcy5VUkxNYW5hZ2VyLnB1c2hTdGF0ZVRvVVJMLmJpbmQodGhpcy5VUkxNYW5hZ2VyKSxcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGN1cnJlbnQsXG4gICAgICAgICAgICAgICAgZmlsdGVycyxcbiAgICAgICAgICAgICAgICByZXN1bHRzUGVyUGFnZSxcbiAgICAgICAgICAgICAgICBzZWFyY2hUZXJtLFxuICAgICAgICAgICAgICAgIHNvcnREaXJlY3Rpb24sXG4gICAgICAgICAgICAgICAgc29ydEZpZWxkLFxuICAgICAgICAgICAgICAgIHNvcnRMaXN0XG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIHsgcmVwbGFjZVVybCB9XG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgZXJyb3IgPT4ge1xuICAgICAgICAgIHRoaXMuX3NldFN0YXRlKHtcbiAgICAgICAgICAgIGVycm9yOiBgQW4gdW5leHBlY3RlZCBlcnJvciBvY2N1cnJlZDogJHtlcnJvci5tZXNzYWdlfWBcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgKTtcbiAgICB9XG4gICk7XG5cbiAgX3NldFN0YXRlKG5ld1N0YXRlKSB7XG4gICAgY29uc3Qgc3RhdGUgPSB7IC4uLnRoaXMuc3RhdGUsIC4uLm5ld1N0YXRlIH07XG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWNvbnNvbGVcbiAgICBpZiAodGhpcy5kZWJ1ZykgY29uc29sZS5sb2coXCJTZWFyY2ggVUk6IFN0YXRlIFVwZGF0ZVwiLCBuZXdTdGF0ZSwgc3RhdGUpO1xuICAgIHRoaXMuc3RhdGUgPSBzdGF0ZTtcbiAgICB0aGlzLnN1YnNjcmlwdGlvbnMuZm9yRWFjaChzdWJzY3JpcHRpb24gPT4gc3Vic2NyaXB0aW9uKHN0YXRlKSk7XG4gIH1cblxuICAvKipcbiAgICogRHluYW1pY2FsbHkgdXBkYXRlIHRoZSBzZWFyY2hRdWVyeSBjb25maWd1cmF0aW9uIGluIHRoaXMgZHJpdmVyLlxuICAgKiBUaGlzIHdpbGwgaXNzdWUgYSBuZXcgcXVlcnkgYWZ0ZXIgYmVpbmcgdXBkYXRlZC5cbiAgICpcbiAgICogQHBhcmFtIE9iamVjdCBzZWFyY2hRdWVyeVxuICAgKi9cbiAgc2V0U2VhcmNoUXVlcnkoc2VhcmNoUXVlcnkpIHtcbiAgICB0aGlzLnNlYXJjaFF1ZXJ5ID0gc2VhcmNoUXVlcnk7XG4gICAgdGhpcy5fdXBkYXRlU2VhcmNoUmVzdWx0cygpO1xuICB9XG5cbiAgLyoqXG4gICAqIEBwYXJhbSBPYmplY3QgYXV0b2NvbXBsZXRlUXVlcnlcbiAgICovXG4gIHNldEF1dG9jb21wbGV0ZVF1ZXJ5KGF1dG9jb21wbGV0ZVF1ZXJ5KSB7XG4gICAgdGhpcy5hdXRvY29tcGxldGVRdWVyeSA9IGF1dG9jb21wbGV0ZVF1ZXJ5O1xuICB9XG5cbiAgLyoqXG4gICAqIEFueSB0aW1lIHN0YXRlIGlzIHVwZGF0ZWQgaW4gdGhpcyBEcml2ZXIsIHRoZSBwcm92aWRlZCBjYWxsYmFja1xuICAgKiB3aWxsIGJlIGV4ZWN1dGVkIHdpdGggdGhlIHVwZGF0ZWQgc3RhdGUuXG4gICAqXG4gICAqIEBwYXJhbSBvblN0YXRlQ2hhbmdlIEZ1bmN0aW9uXG4gICAqL1xuICBzdWJzY3JpYmVUb1N0YXRlQ2hhbmdlcyhvblN0YXRlQ2hhbmdlKSB7XG4gICAgdGhpcy5zdWJzY3JpcHRpb25zLnB1c2gob25TdGF0ZUNoYW5nZSk7XG4gIH1cblxuICAvKipcbiAgICogQHBhcmFtIG9uU3RhdGVDaGFuZ2UgRnVuY3Rpb25cbiAgICovXG4gIHVuc3Vic2NyaWJlVG9TdGF0ZUNoYW5nZXMob25TdGF0ZUNoYW5nZSkge1xuICAgIHRoaXMuc3Vic2NyaXB0aW9ucyA9IHRoaXMuc3Vic2NyaXB0aW9ucy5maWx0ZXIoXG4gICAgICBzdWIgPT4gc3ViICE9PSBvblN0YXRlQ2hhbmdlXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmUgYWxsIGxpc3RlbmVyc1xuICAgKi9cbiAgdGVhckRvd24oKSB7XG4gICAgdGhpcy5zdWJzY3JpcHRpb25zID0gW107XG4gICAgdGhpcy5VUkxNYW5hZ2VyICYmIHRoaXMuVVJMTWFuYWdlci50ZWFyRG93bigpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHJpZXZlcyBhbGwgYXZhaWxhYmxlIGFjaXRvbnNcbiAgICpcbiAgICogQHJldHVybnMgT2JqZWN0IEFsbCBhY3Rpb25zXG4gICAqL1xuICBnZXRBY3Rpb25zKCkge1xuICAgIHJldHVybiB0aGlzLmFjdGlvbnM7XG4gIH1cblxuICAvKipcbiAgICogUmV0cmlldmUgY3VycmVudCBzdGF0ZS4gVHlwaWNhbGx5IHVzZWQgb24gYXBwIGluaXRpYWxpemF0aW9uLiBTdWJzZXF1ZW50XG4gICAqIHN0YXRlIHVwZGF0ZXMgc2hvdWxkIGNvbWUgdGhyb3VnaCBzdWJzY3JpcHRpb24uXG4gICAqXG4gICAqIEByZXR1cm5zIE9iamVjdCBDdXJyZW50IHN0YXRlXG4gICAqL1xuICBnZXRTdGF0ZSgpIHtcbiAgICAvLyBXZSByZXR1cm4gYSBjb3B5IG9mIHN0YXRlIGhlcmUsIGJlY2F1c2Ugd2Ugd2FudCB0byBlbnN1cmUgdGhlIHN0YXRlXG4gICAgLy8gaW5zaWRlIG9mIHRoaXMgb2JqZWN0IHJlbWFpbnMgaW1tdXRhYmxlLlxuICAgIHJldHVybiB7IC4uLnRoaXMuc3RhdGUgfTtcbiAgfVxufVxuIl19